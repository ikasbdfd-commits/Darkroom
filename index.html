<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Sƒ±nƒ±f Dersi üìö</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #1a1a2e;
    --panel: #16213e;
    --card: #0f3460;
    --accent: #e94560;
    --green: #0cce6b;
    --yellow: #f7c59f;
    --text: #eaeaea;
    --chalk: #f0ede0;
  }

  body {
    font-family: 'Nunito', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow: hidden;
    touch-action: manipulation;
  }

  /* ===== SCREENS ===== */
  .screen { display: none; width: 100vw; height: 100vh; }
  .screen.active { display: flex; flex-direction: column; align-items: center; justify-content: center; }

  /* ===== LOBBY ===== */
  #lobbyScreen {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    padding: 20px;
  }

  .lobby-title {
    font-family: 'Fredoka One', cursive;
    font-size: 2.4em;
    color: var(--yellow);
    text-align: center;
    margin-bottom: 8px;
    text-shadow: 0 0 20px rgba(247,197,159,0.4);
  }

  .lobby-sub {
    font-size: 0.9em;
    color: #aaa;
    text-align: center;
    margin-bottom: 30px;
  }

  .lobby-card {
    background: var(--card);
    border-radius: 20px;
    padding: 28px 24px;
    width: 100%;
    max-width: 340px;
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }

  .input-group { margin-bottom: 16px; }
  .input-group label { display: block; font-size: 0.8em; color: #aaa; margin-bottom: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

  input[type=text] {
    width: 100%;
    padding: 12px 16px;
    border-radius: 12px;
    border: 2px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.05);
    color: var(--text);
    font-family: 'Nunito', sans-serif;
    font-size: 1em;
    font-weight: 700;
    outline: none;
    transition: border-color 0.3s;
  }
  input[type=text]:focus { border-color: var(--accent); }

  .btn {
    width: 100%;
    padding: 14px;
    border-radius: 14px;
    border: none;
    font-family: 'Fredoka One', cursive;
    font-size: 1.1em;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.5px;
    margin-top: 8px;
  }
  .btn:active { transform: scale(0.96); }
  .btn-red { background: var(--accent); color: white; box-shadow: 0 4px 20px rgba(233,69,96,0.4); }
  .btn-green { background: var(--green); color: #0a0a0a; box-shadow: 0 4px 20px rgba(12,206,107,0.4); }
  .btn-gray { background: rgba(255,255,255,0.1); color: var(--text); }

  .divider { text-align: center; color: #555; margin: 14px 0; font-size: 0.85em; }

  /* ===== WAITING ===== */
  #waitingScreen {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    padding: 20px;
  }

  .waiting-card {
    background: var(--card);
    border-radius: 20px;
    padding: 32px 24px;
    width: 100%;
    max-width: 340px;
    text-align: center;
    border: 1px solid rgba(255,255,255,0.1);
  }

  .room-code-display {
    font-family: 'Fredoka One', cursive;
    font-size: 3em;
    color: var(--yellow);
    letter-spacing: 6px;
    margin: 16px 0;
    text-shadow: 0 0 20px rgba(247,197,159,0.3);
  }

  .players-list { margin: 20px 0; }
  .player-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    margin-bottom: 8px;
    font-weight: 700;
  }
  .player-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--green); }
  .player-dot.empty { background: #444; }

  .waiting-anim {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin: 16px 0;
  }
  .waiting-anim span {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--accent);
    animation: bounce 1.2s infinite;
  }
  .waiting-anim span:nth-child(2) { animation-delay: 0.2s; }
  .waiting-anim span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes bounce {
    0%,60%,100% { transform: translateY(0); opacity: 0.4; }
    30% { transform: translateY(-10px); opacity: 1; }
  }

  /* ===== CLASSROOM ===== */
  #gameScreen {
    background: #8B7355;
    overflow: hidden;
    position: relative;
    padding: 0;
    justify-content: flex-start;
  }

  .classroom {
    width: 100%;
    height: 100%;
    position: relative;
    background: #d4c5a0;
    overflow: hidden;
  }

  /* Floor */
  .floor {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 35%;
    background: linear-gradient(180deg, #c8a96e 0%, #b8956a 100%);
  }

  /* Back wall */
  .back-wall {
    position: absolute;
    top: 0;
    width: 100%;
    height: 65%;
    background: linear-gradient(180deg, #8fb5c8 0%, #7aa4b8 100%);
  }

  /* Blackboard */
  .blackboard {
    position: absolute;
    top: 8%;
    left: 50%;
    transform: translateX(-50%);
    width: 60%;
    height: 30%;
    background: #2d4a2d;
    border: 6px solid #8B6914;
    border-radius: 4px;
    box-shadow: 4px 4px 0 #5a4510;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .chalk-text {
    font-family: 'Fredoka One', cursive;
    color: rgba(240,237,224,0.85);
    font-size: clamp(0.5em, 2vw, 0.9em);
    text-align: center;
    padding: 8px;
    line-height: 1.8;
    text-shadow: 1px 1px 0 rgba(255,255,255,0.1);
  }

  /* Teacher */
  .teacher {
    position: absolute;
    top: 28%;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 55px;
    z-index: 5;
  }

  .teacher-head {
    width: 20px; height: 20px;
    background: #FDBCB4;
    border-radius: 50%;
    margin: 0 auto;
    position: relative;
    border: 2px solid #d4957a;
  }
  .teacher-head::after {
    content: '';
    position: absolute;
    top: -6px; left: -2px;
    width: 24px; height: 12px;
    background: #4a3728;
    border-radius: 50% 50% 0 0;
  }
  .teacher-body {
    width: 28px; height: 28px;
    background: #2c3e8c;
    border-radius: 4px 4px 0 0;
    margin: 0 auto;
    position: relative;
  }
  .teacher-body::before {
    content: '';
    position: absolute;
    top: 2px; left: 50%;
    transform: translateX(-50%);
    width: 4px; height: 20px;
    background: #e74c3c;
    border-radius: 2px;
  }

  /* Teacher looking animation */
  .teacher.looking {
    animation: teacherLook 0.5s ease;
  }
  @keyframes teacherLook {
    0% { transform: translateX(-50%) rotate(0deg); }
    25% { transform: translateX(-50%) rotate(-5deg) scale(1.1); }
    50% { transform: translateX(-50%) rotate(5deg) scale(1.15); }
    100% { transform: translateX(-50%) rotate(0deg) scale(1); }
  }

  /* Background students */
  .bg-students {
    position: absolute;
    bottom: 35%;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-around;
    padding: 0 5%;
  }

  .desk-row {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .mini-desk {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .mini-student-head {
    width: 14px; height: 14px;
    border-radius: 50%;
    margin-bottom: 2px;
  }
  .mini-student-body {
    width: 18px; height: 14px;
    border-radius: 3px 3px 0 0;
  }
  .mini-table {
    width: 26px; height: 6px;
    background: #8B7355;
    border-radius: 2px;
    border: 1px solid #6b5335;
  }

  /* Our desks (foreground) */
  .our-seats {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 40%;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    gap: 8px;
    padding-bottom: 10px;
    perspective: 400px;
  }

  .our-desk-unit {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
  }

  .player-char {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 2px;
    position: relative;
    transition: transform 0.3s ease;
  }

  .char-head {
    width: 28px; height: 28px;
    border-radius: 50%;
    background: #FDBCB4;
    border: 2px solid #d4957a;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.65em;
    overflow: hidden;
  }

  .char-eyes {
    display: flex;
    gap: 5px;
    margin-top: 4px;
  }
  .char-eye {
    width: 4px; height: 4px;
    background: #2c2c2c;
    border-radius: 50%;
    transition: all 0.3s;
  }

  .char-body {
    width: 32px; height: 28px;
    border-radius: 4px 4px 0 0;
    position: relative;
  }

  .our-desk-table {
    width: 70px; height: 8px;
    background: #8B7355;
    border-radius: 3px;
    border: 2px solid #6b5335;
    box-shadow: 0 2px 0 #4a3520;
  }

  .player-name-tag {
    font-size: 0.6em;
    background: rgba(0,0,0,0.6);
    color: white;
    padding: 2px 6px;
    border-radius: 8px;
    margin-top: 2px;
    font-weight: 700;
    max-width: 60px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Poke animation */
  .player-char.poking {
    animation: pokeAnim 0.4s ease;
  }
  @keyframes pokeAnim {
    0% { transform: translateX(0); }
    25% { transform: translateX(12px) rotate(5deg); }
    50% { transform: translateX(-4px); }
    100% { transform: translateX(0) rotate(0); }
  }

  .player-char.poked {
    animation: pokedAnim 0.5s ease;
  }
  @keyframes pokedAnim {
    0% { transform: rotate(0); }
    20% { transform: rotate(-8deg) translateX(-4px); }
    40% { transform: rotate(6deg); }
    60% { transform: rotate(-4deg); }
    100% { transform: rotate(0); }
  }

  /* Talking indicator */
  .talk-bubble {
    position: absolute;
    top: -20px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    color: #333;
    font-size: 0.55em;
    padding: 2px 6px;
    border-radius: 8px;
    white-space: nowrap;
    font-weight: 700;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
  }
  .talk-bubble.visible { opacity: 1; }
  .talk-bubble::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 50%;
    transform: translateX(-50%);
    width: 6px; height: 4px;
    background: white;
    clip-path: polygon(0 0, 100% 0, 50% 100%);
  }

  /* ===== GAME UI OVERLAY ===== */
  .game-ui {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 100;
    padding: 12px;
    background: linear-gradient(transparent, rgba(0,0,0,0.85));
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: rgba(0,0,0,0.6);
    border-radius: 12px;
    backdrop-filter: blur(10px);
  }

  .danger-meter {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
  }

  .danger-label { font-size: 0.7em; color: #aaa; font-weight: 700; }

  .meter-bar {
    flex: 1;
    height: 8px;
    background: rgba(255,255,255,0.1);
    border-radius: 4px;
    overflow: hidden;
  }
  .meter-fill {
    height: 100%;
    border-radius: 4px;
    background: var(--green);
    transition: width 0.3s, background 0.3s;
  }
  .meter-fill.danger { background: var(--accent); }
  .meter-fill.warning { background: #f39c12; }

  .score-display {
    font-family: 'Fredoka One', cursive;
    font-size: 1.1em;
    color: var(--yellow);
    margin-left: 12px;
  }

  .action-buttons {
    display: flex;
    gap: 10px;
  }

  .btn-action {
    flex: 1;
    padding: 14px 10px;
    border-radius: 16px;
    border: none;
    font-family: 'Fredoka One', cursive;
    font-size: 1em;
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
    overflow: hidden;
  }
  .btn-action:active { transform: scale(0.94); }

  .btn-talk {
    background: linear-gradient(135deg, #e94560, #c0392b);
    color: white;
    box-shadow: 0 4px 20px rgba(233,69,96,0.5);
  }

  .btn-poke {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    color: white;
    box-shadow: 0 4px 20px rgba(243,156,18,0.5);
  }

  .btn-action.cooldown {
    opacity: 0.5;
    pointer-events: none;
  }

  .btn-action .cd-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8em;
    opacity: 0;
  }
  .btn-action.cooldown .cd-overlay { opacity: 1; }

  /* ===== CAUGHT OVERLAY ===== */
  #caughtOverlay {
    position: fixed;
    inset: 0;
    z-index: 200;
    background: rgba(0,0,0,0.9);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s;
  }
  #caughtOverlay.show {
    opacity: 1;
    pointer-events: all;
  }

  .caught-emoji {
    font-size: 5em;
    animation: shake 0.5s ease;
    margin-bottom: 16px;
  }
  @keyframes shake {
    0%,100% { transform: rotate(0); }
    20% { transform: rotate(-10deg); }
    40% { transform: rotate(10deg); }
    60% { transform: rotate(-8deg); }
    80% { transform: rotate(8deg); }
  }

  .caught-title {
    font-family: 'Fredoka One', cursive;
    font-size: 2em;
    color: var(--accent);
    margin-bottom: 8px;
  }

  .caught-score {
    font-size: 1.1em;
    color: #aaa;
    margin-bottom: 24px;
  }

  .caught-score span {
    color: var(--yellow);
    font-weight: 800;
    font-size: 1.3em;
  }

  /* ===== TEACHER ALERT ===== */
  #teacherAlert {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-80px);
    background: var(--accent);
    color: white;
    padding: 10px 20px;
    border-radius: 20px;
    font-family: 'Fredoka One', cursive;
    font-size: 1em;
    z-index: 150;
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    white-space: nowrap;
    box-shadow: 0 4px 20px rgba(233,69,96,0.6);
  }
  #teacherAlert.show {
    transform: translateX(-50%) translateY(0);
  }

  /* Poke notification */
  #pokeNotif {
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%) translateY(-80px);
    background: #f39c12;
    color: white;
    padding: 8px 18px;
    border-radius: 16px;
    font-family: 'Fredoka One', cursive;
    font-size: 0.9em;
    z-index: 150;
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    white-space: nowrap;
    box-shadow: 0 4px 20px rgba(243,156,18,0.5);
  }
  #pokeNotif.show {
    transform: translateX(-50%) translateY(0);
  }

  /* Score pop */
  .score-pop {
    position: fixed;
    font-family: 'Fredoka One', cursive;
    font-size: 1.8em;
    color: var(--green);
    pointer-events: none;
    z-index: 300;
    animation: scorePop 1s forwards;
  }
  @keyframes scorePop {
    0% { transform: translateY(0) scale(0.5); opacity: 1; }
    60% { transform: translateY(-60px) scale(1.2); opacity: 1; }
    100% { transform: translateY(-100px) scale(1); opacity: 0; }
  }

  /* ===== UTIL ===== */
  .hidden { display: none !important; }

  /* Teacher walking */
  .teacher.walking {
    animation: teacherWalk 2s linear infinite;
  }
  @keyframes teacherWalk {
    0% { left: 35%; }
    50% { left: 65%; }
    100% { left: 35%; }
  }

  /* Caught flash */
  @keyframes flashRed {
    0%,100% { background: rgba(0,0,0,0); }
    50% { background: rgba(233,69,96,0.3); }
  }
  .flash-red {
    animation: flashRed 0.3s ease 3;
  }
</style>
</head>
<body>

<!-- LOBBY -->
<div id="lobbyScreen" class="screen active">
  <div class="lobby-title">üìö Ders Zamanƒ±</div>
  <p class="lobby-sub">Arkada≈üƒ±nla sƒ±nƒ±fta konu≈ü, yakalanma!</p>

  <div class="lobby-card">
    <div class="input-group">
      <label>Adƒ±n</label>
      <input type="text" id="nameInput" placeholder="ƒ∞sminizi girin..." maxlength="12">
    </div>

    <button class="btn btn-red" onclick="createRoom()">üè´ Oda Olu≈ütur</button>

    <div class="divider">‚Äî veya ‚Äî</div>

    <div class="input-group">
      <label>Oda Kodu</label>
      <input type="text" id="roomInput" placeholder="Oda kodunu girin..." maxlength="6" style="text-transform:uppercase">
    </div>
    <button class="btn btn-green" onclick="joinRoom()">üö™ Odaya Katƒ±l</button>
  </div>
</div>

<!-- WAITING -->
<div id="waitingScreen" class="screen">
  <div class="waiting-card">
    <div style="font-size:0.8em;color:#aaa;text-transform:uppercase;letter-spacing:2px;">Oda Kodu</div>
    <div class="room-code-display" id="displayRoomCode">----</div>
    <div style="font-size:0.85em;color:#aaa;margin-bottom:16px;">Arkada≈üƒ±na bu kodu g√∂nder</div>

    <div class="players-list" id="playersList"></div>

    <div class="waiting-anim">
      <span></span><span></span><span></span>
    </div>
    <div style="font-size:0.85em;color:#aaa;" id="waitingMsg">Oyuncular bekleniyor...</div>
  </div>
</div>

<!-- GAME -->
<div id="gameScreen" class="screen">
  <div class="classroom" id="classroom">
    <div class="back-wall"></div>
    <div class="floor"></div>

    <div class="blackboard">
      <div class="chalk-text" id="chalkText">
        Matematik Dersi<br>
        f(x) = ax¬≤ + bx + c<br>
        ‚à´‚ÇÄ¬π x¬≤ dx = 1/3
      </div>
    </div>

    <div class="teacher" id="teacher">
      <div class="teacher-head"></div>
      <div class="teacher-body"></div>
    </div>

    <div class="bg-students" id="bgStudents"></div>

    <div class="our-seats" id="ourSeats"></div>
  </div>

  <div class="game-ui">
    <div class="status-bar">
      <div class="danger-meter">
        <div class="danger-label">‚ö†Ô∏è TEHLƒ∞KE</div>
        <div class="meter-bar">
          <div class="meter-fill" id="dangerFill" style="width:0%"></div>
        </div>
      </div>
      <div class="score-display">‚≠ê <span id="scoreDisplay">0</span></div>
    </div>

    <div class="action-buttons">
      <button class="btn-action btn-talk" id="talkBtn" onmousedown="startTalking()" onmouseup="stopTalking()" ontouchstart="startTalking(event)" ontouchend="stopTalking(event)">
        üí¨ Konu≈ü
        <div class="cd-overlay" id="talkCooldown"></div>
      </button>
      <button class="btn-action btn-poke" id="pokeBtn" onclick="sendPoke()">
        üëâ D√ºrt
        <div class="cd-overlay" id="pokeCooldown"></div>
      </button>
    </div>
  </div>
</div>

<!-- ALERTS -->
<div id="teacherAlert">üëÄ √ñƒüretmen bakƒ±yor! KONU≈ûMA!</div>
<div id="pokeNotif">üëâ Arkada≈üƒ±n seni d√ºrt√ºyor! Konu≈ü!</div>

<!-- CAUGHT OVERLAY -->
<div id="caughtOverlay">
  <div class="caught-emoji">üò±</div>
  <div class="caught-title">YAKALANDIK!</div>
  <div class="caught-score">Toplam s√ºre: <span id="finalScore">0</span> saniye</div>
  <button class="btn btn-red" style="width:200px;margin-top:10px;" onclick="restartGame()">üîÑ Tekrar Oyna</button>
  <button class="btn btn-gray" style="width:200px;margin-top:8px;" onclick="goLobby()">üè† Ana Men√º</button>
</div>

<script>
// ===== CONFIG =====
const REDIS_URL = "https://informed-hen-11704.upstash.io";
const REDIS_TOKEN = "AS24AAIncDFkZWFiODQ5MTkxNTk0MTAxODk1NWY1Y2RlOTRjYTU3OHAxMTE3MDQ";

// ===== STATE =====
let myName = '';
let roomCode = '';
let myId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
let isHost = false;
let players = {};
let gameActive = false;
let isTalking = false;
let talkStartTime = 0;
let totalTalkTime = 0;
let dangerLevel = 0;
let score = 0;
let pollInterval = null;
let gameInterval = null;
let talkCooldownTimer = null;
let pokeCooldownTimer = null;
let teacherLooking = false;
let teacherLookCountdown = 0;

// ===== REDIS HELPERS =====
async function redisGet(key) {
  try {
    const res = await fetch(`${REDIS_URL}/get/${encodeURIComponent(key)}`, {
      headers: { Authorization: `Bearer ${REDIS_TOKEN}` }
    });
    const data = await res.json();
    return data.result ? JSON.parse(data.result) : null;
  } catch { return null; }
}

async function redisSet(key, value, exSeconds = 300) {
  try {
    await fetch(`${REDIS_URL}/set/${encodeURIComponent(key)}/${encodeURIComponent(JSON.stringify(value))}?ex=${exSeconds}`, {
      headers: { Authorization: `Bearer ${REDIS_TOKEN}` }
    });
  } catch {}
}

async function redisDel(key) {
  try {
    await fetch(`${REDIS_URL}/del/${encodeURIComponent(key)}`, {
      headers: { Authorization: `Bearer ${REDIS_TOKEN}` }
    });
  } catch {}
}

// ===== ROOM =====
function generateCode() {
  return Math.random().toString(36).substr(2, 4).toUpperCase();
}

async function createRoom() {
  const name = document.getElementById('nameInput').value.trim();
  if (!name) { alert('ƒ∞sminizi girin!'); return; }
  myName = name;
  roomCode = generateCode();
  isHost = true;

  const roomData = {
    players: { [myId]: { name: myName, id: myId } },
    state: 'waiting',
    events: [],
    createdAt: Date.now()
  };
  await redisSet(`room:${roomCode}`, roomData);

  showWaiting();
  startPolling();
}

async function joinRoom() {
  const name = document.getElementById('nameInput').value.trim();
  const code = document.getElementById('roomInput').value.trim().toUpperCase();
  if (!name) { alert('ƒ∞sminizi girin!'); return; }
  if (!code) { alert('Oda kodunu girin!'); return; }

  myName = name;
  roomCode = code;
  isHost = false;

  const roomData = await redisGet(`room:${roomCode}`);
  if (!roomData) { alert('Oda bulunamadƒ±!'); return; }
  if (roomData.state === 'playing') { alert('Oyun zaten ba≈üladƒ±!'); return; }
  if (Object.keys(roomData.players).length >= 2) { alert('Oda dolu!'); return; }

  roomData.players[myId] = { name: myName, id: myId };
  await redisSet(`room:${roomCode}`, roomData);

  showWaiting();
  startPolling();
}

// ===== SCREENS =====
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function showWaiting() {
  showScreen('waitingScreen');
  document.getElementById('displayRoomCode').textContent = roomCode;
}

// ===== POLLING =====
function startPolling() {
  pollInterval = setInterval(poll, 1000);
  poll();
}

function stopPolling() {
  clearInterval(pollInterval);
  pollInterval = null;
}

async function poll() {
  const roomData = await redisGet(`room:${roomCode}`);
  if (!roomData) return;

  players = roomData.players;
  const playerList = Object.values(players);

  if (document.getElementById('waitingScreen').classList.contains('active')) {
    renderWaiting(playerList);
    if (playerList.length >= 2 && roomData.state === 'playing') {
      startGame();
    } else if (isHost && playerList.length >= 2 && roomData.state === 'waiting') {
      roomData.state = 'playing';
      await redisSet(`room:${roomCode}`, roomData);
      startGame();
    }
  } else if (gameActive) {
    handleGameEvents(roomData);
  }
}

function renderWaiting(playerList) {
  const list = document.getElementById('playersList');
  list.innerHTML = '';
  for (let i = 0; i < 2; i++) {
    const p = playerList[i];
    const div = document.createElement('div');
    div.className = 'player-item';
    div.innerHTML = `<div class="player-dot ${p ? '' : 'empty'}"></div><span>${p ? p.name : 'Bekleniyor...'}</span>`;
    list.appendChild(div);
  }
  const msg = document.getElementById('waitingMsg');
  msg.textContent = playerList.length >= 2 ? '‚úÖ Oyun ba≈ülƒ±yor!' : 'Arkada≈üƒ±n katƒ±lsƒ±n...';
}

// ===== GAME START =====
function startGame() {
  stopPolling();
  showScreen('gameScreen');
  gameActive = true;
  score = 0;
  dangerLevel = 0;
  totalTalkTime = 0;
  updateScoreDisplay();

  buildClassroom();
  startGameLoop();
  startPolling();
}

function buildClassroom() {
  buildBgStudents();
  buildOurSeats();
}

const skinColors = ['#FDBCB4','#F1A173','#D4875A','#C36B3A','#A0522D'];
const shirtColors = ['#e74c3c','#3498db','#2ecc71','#9b59b6','#f39c12','#1abc9c'];

function buildBgStudents() {
  const container = document.getElementById('bgStudents');
  container.innerHTML = '';
  for (let col = 0; col < 4; col++) {
    const row = document.createElement('div');
    row.className = 'desk-row';
    for (let r = 0; r < 2; r++) {
      const skin = skinColors[Math.floor(Math.random() * skinColors.length)];
      const shirt = shirtColors[Math.floor(Math.random() * shirtColors.length)];
      const div = document.createElement('div');
      div.className = 'mini-desk';
      div.innerHTML = `
        <div class="mini-student-head" style="background:${skin};border:1px solid #aaa;"></div>
        <div class="mini-student-body" style="background:${shirt};"></div>
        <div class="mini-table"></div>
      `;
      row.appendChild(div);
    }
    container.appendChild(row);
  }
}

function buildOurSeats() {
  const container = document.getElementById('ourSeats');
  container.innerHTML = '';
  const playerList = Object.values(players);

  playerList.forEach((p, i) => {
    const isMe = p.id === myId;
    const skin = skinColors[i % skinColors.length];
    const shirt = shirtColors[(i + 2) % shirtColors.length];

    const unit = document.createElement('div');
    unit.className = 'our-desk-unit';
    unit.innerHTML = `
      <div class="player-char ${isMe ? 'me' : 'other'}" id="char_${p.id}">
        <div class="talk-bubble" id="bubble_${p.id}">psst... üó£Ô∏è</div>
        <div class="char-head" style="background:${skin}">
          <div class="char-eyes">
            <div class="char-eye" id="eye1_${p.id}"></div>
            <div class="char-eye" id="eye2_${p.id}"></div>
          </div>
        </div>
        <div class="char-body" style="background:${shirt}"></div>
      </div>
      <div class="our-desk-table"></div>
      <div class="player-name-tag">${isMe ? 'üë§ ' + p.name : p.name}</div>
    `;
    container.appendChild(unit);
  });
}

// ===== GAME LOOP =====
const chalkTexts = [
  "Matematik Dersi\nf(x) = ax¬≤ + bx + c\n‚à´‚ÇÄ¬π x¬≤ dx = 1/3",
  "Fizik\nF = ma\nE = mc¬≤",
  "T√ºrk√ße\nEylem √ßekimi\nZaman kiplarƒ±",
  "Tarih\n1453 ƒ∞stanbul\nOsmanlƒ± d√∂nemi",
  "ƒ∞ngilizce\nPresent Perfect\nHave / Has + V¬≥"
];

let chalkIdx = 0;
let scoreTick = 0;
let teacherTimer = 0;
let teacherLookTimer = 0;

function startGameLoop() {
  gameInterval = setInterval(gameLoop, 100);
}

function gameLoop() {
  if (!gameActive) return;

  scoreTick++;
  if (scoreTick % 10 === 0) { // every 1 second
    score++;
    updateScoreDisplay();

    // Change chalk text every 15 sec
    if (score % 15 === 0) {
      chalkIdx = (chalkIdx + 1) % chalkTexts.length;
      document.getElementById('chalkText').style.whiteSpace = 'pre';
      document.getElementById('chalkText').textContent = chalkTexts[chalkIdx];
    }
  }

  // Danger decrease when not talking
  if (!isTalking) {
    dangerLevel = Math.max(0, dangerLevel - 0.3);
  }

  // Teacher random looking
  teacherTimer++;
  if (!teacherLooking && teacherTimer > (80 + Math.random() * 80)) {
    teacherTimer = 0;
    triggerTeacherLook();
  }

  updateDangerMeter();
}

function triggerTeacherLook() {
  teacherLooking = true;
  teacherLookTimer = 30;
  const teacher = document.getElementById('teacher');
  teacher.classList.add('looking');
  showTeacherAlert();

  setTimeout(() => {
    teacher.classList.remove('looking');
  }, 500);

  const lookInterval = setInterval(() => {
    teacherLookTimer--;
    if (teacherLookTimer <= 0) {
      teacherLooking = false;
      clearInterval(lookInterval);
    }
    // Caught if talking while teacher is looking
    if (isTalking && teacherLooking) {
      clearInterval(lookInterval);
      teacherLooking = false;
      caught();
    }
  }, 100);
}

function showTeacherAlert() {
  const alert = document.getElementById('teacherAlert');
  alert.classList.add('show');
  setTimeout(() => alert.classList.remove('show'), 2500);
}

function updateDangerMeter() {
  const fill = document.getElementById('dangerFill');
  fill.style.width = dangerLevel + '%';
  fill.className = 'meter-fill' + (dangerLevel > 70 ? ' danger' : dangerLevel > 40 ? ' warning' : '');
}

function updateScoreDisplay() {
  document.getElementById('scoreDisplay').textContent = score;
}

// ===== ACTIONS =====
function startTalking(e) {
  if (e) e.preventDefault();
  if (!gameActive) return;
  const btn = document.getElementById('talkBtn');
  if (btn.classList.contains('cooldown')) return;

  isTalking = true;
  talkStartTime = Date.now();

  // Show talk bubble for me
  const myChar = document.querySelector('.char.me') || document.getElementById('char_' + myId);
  const bubble = document.getElementById('bubble_' + myId);
  if (bubble) bubble.classList.add('visible');

  // Increase danger
  const talkInterval = setInterval(() => {
    if (!isTalking) { clearInterval(talkInterval); return; }
    dangerLevel = Math.min(100, dangerLevel + 2);
    if (dangerLevel >= 100 && teacherLooking) {
      clearInterval(talkInterval);
      caught();
    }
    updateDangerMeter();
  }, 100);

  // Push event to redis
  pushEvent({ type: 'talk', playerId: myId, on: true });
}

function stopTalking(e) {
  if (e) e.preventDefault();
  if (!isTalking) return;
  isTalking = false;

  const bubble = document.getElementById('bubble_' + myId);
  if (bubble) bubble.classList.remove('visible');

  const talkDur = (Date.now() - talkStartTime) / 1000;
  totalTalkTime += talkDur;

  pushEvent({ type: 'talk', playerId: myId, on: false });
}

async function sendPoke() {
  const btn = document.getElementById('pokeBtn');
  if (btn.classList.contains('cooldown')) return;

  // Animate my char
  const myChar = document.getElementById('char_' + myId);
  if (myChar) {
    myChar.classList.add('poking');
    setTimeout(() => myChar.classList.remove('poking'), 400);
  }

  await pushEvent({ type: 'poke', fromId: myId });

  // Cooldown
  btn.classList.add('cooldown');
  let cd = 3;
  btn.querySelector('.cd-overlay').textContent = cd + 's';
  const timer = setInterval(() => {
    cd--;
    btn.querySelector('.cd-overlay').textContent = cd + 's';
    if (cd <= 0) {
      clearInterval(timer);
      btn.classList.remove('cooldown');
    }
  }, 1000);
}

// ===== EVENTS =====
async function pushEvent(event) {
  const roomData = await redisGet(`room:${roomCode}`);
  if (!roomData) return;
  event.ts = Date.now();
  event.id = Math.random().toString(36).substr(2, 8);
  if (!roomData.events) roomData.events = [];
  roomData.events.push(event);
  // Keep only last 20 events
  if (roomData.events.length > 20) roomData.events = roomData.events.slice(-20);
  await redisSet(`room:${roomCode}`, roomData);
}

let processedEvents = new Set();

function handleGameEvents(roomData) {
  if (!roomData.events) return;
  roomData.events.forEach(ev => {
    if (processedEvents.has(ev.id)) return;
    processedEvents.add(ev.id);

    if (ev.playerId === myId || ev.fromId === myId) return; // ignore own events

    if (ev.type === 'talk') {
      const bubble = document.getElementById('bubble_' + ev.playerId);
      if (bubble) bubble.classList.toggle('visible', ev.on);
    }

    if (ev.type === 'poke') {
      // Animate other player poking me
      const otherChar = document.getElementById('char_' + ev.fromId);
      if (otherChar) {
        otherChar.classList.add('poking');
        setTimeout(() => otherChar.classList.remove('poking'), 400);
      }
      // I get poked
      const myChar = document.getElementById('char_' + myId);
      if (myChar) {
        myChar.classList.add('poked');
        setTimeout(() => myChar.classList.remove('poked'), 500);
      }
      // Show poke notification
      const notif = document.getElementById('pokeNotif');
      notif.textContent = 'üëâ ' + (players[ev.fromId]?.name || 'Arkada≈üƒ±n') + ' seni d√ºrt√ºyor! Konu≈ü!';
      notif.classList.add('show');
      setTimeout(() => notif.classList.remove('show'), 2500);
    }

    if (ev.type === 'caught') {
      caught(true);
    }
  });
}

// ===== CAUGHT =====
async function caught(fromRemote = false) {
  if (!gameActive) return;
  gameActive = false;
  isTalking = false;
  clearInterval(gameInterval);

  // Flash
  document.getElementById('classroom').classList.add('flash-red');
  setTimeout(() => document.getElementById('classroom').classList.remove('flash-red'), 900);

  if (!fromRemote) {
    await pushEvent({ type: 'caught' });
  }

  document.getElementById('finalScore').textContent = score;
  setTimeout(() => {
    document.getElementById('caughtOverlay').classList.add('show');
  }, 600);
}

function restartGame() {
  document.getElementById('caughtOverlay').classList.remove('show');
  score = 0;
  dangerLevel = 0;
  teacherLooking = false;
  isTalking = false;
  processedEvents = new Set();
  updateScoreDisplay();
  updateDangerMeter();
  gameActive = true;
  startGameLoop();
}

function goLobby() {
  document.getElementById('caughtOverlay').classList.remove('show');
  gameActive = false;
  clearInterval(gameInterval);
  stopPolling();
  showScreen('lobbyScreen');
}

// ===== INIT =====
document.getElementById('roomInput').addEventListener('input', e => {
  e.target.value = e.target.value.toUpperCase();
});

// Prevent scroll on touch
document.addEventListener('touchmove', e => {
  if (gameActive) e.preventDefault();
}, { passive: false });
</script>
</body>
</html>
