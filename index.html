<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>DARKROOM</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Creepster&family=Share+Tech+Mono&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{--red:#ff0033;--green:#00ff41;--yellow:#ffcc00;}
html,body{width:100%;height:100%;overflow:hidden;background:#000;color:var(--green);
  font-family:'Share Tech Mono',monospace;touch-action:none;user-select:none;}

/* PORTRAIT UYARI */
#portrait{position:fixed;inset:0;background:#000;z-index:9999;
  display:none;flex-direction:column;align-items:center;justify-content:center;}
#portrait .ri{font-size:4rem;animation:rspin 1.5s ease-in-out infinite;}
@keyframes rspin{0%,100%{transform:rotate(0deg);}50%{transform:rotate(90deg);}}
#portrait p{font-family:'Creepster',cursive;color:var(--red);font-size:1.3rem;
  margin-top:1rem;letter-spacing:.2em;text-align:center;padding:0 2rem;}
@media(orientation:portrait){#portrait{display:flex;}}
@media(orientation:landscape){#portrait{display:none;}}

/* SCAN + VIGNETTE */
#scan{position:fixed;inset:0;pointer-events:none;z-index:500;
  background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,.05) 3px,rgba(0,0,0,.05) 4px);}
#vig{position:fixed;inset:0;pointer-events:none;z-index:499;
  background:radial-gradient(ellipse at center,transparent 40%,rgba(0,0,0,.8) 100%);}

/* LOBBY */
#lobby{position:fixed;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center;background:#000;z-index:100;padding:1.5rem;}
.logo{font-family:'Creepster',cursive;font-size:clamp(2.8rem,10vw,5rem);
  color:var(--red);text-shadow:0 0 30px var(--red),0 0 80px rgba(255,0,51,.3);
  letter-spacing:.3em;animation:flick 5s infinite;margin-bottom:.1em;text-align:center;}
@keyframes flick{0%,93%,100%{opacity:1}94%{opacity:.15}95%{opacity:1}97%{opacity:.05}98%{opacity:.9}}
.sub{font-size:.6rem;letter-spacing:.5em;color:rgba(0,255,65,.4);margin-bottom:1.5rem;text-align:center;}
.ninput{background:transparent;border:0;border-bottom:1px solid var(--green);
  color:var(--green);font-family:'Share Tech Mono',monospace;font-size:1.1rem;
  padding:.6em .5em;outline:none;text-align:center;width:min(260px,80vw);
  margin-bottom:1.2rem;}
.ninput::placeholder{color:rgba(0,255,65,.25);}
.mode-row{display:flex;gap:.8rem;margin-bottom:1.2rem;width:min(260px,80vw);}
.modeBtn{flex:1;padding:.9em .5em;border:1px solid rgba(0,255,65,.3);background:transparent;
  color:rgba(0,255,65,.5);font-family:'Share Tech Mono',monospace;font-size:.75rem;
  letter-spacing:.1em;text-transform:uppercase;transition:all .2s;cursor:pointer;}
.modeBtn.active{border-color:var(--green);color:var(--green);
  background:rgba(0,255,65,.08);box-shadow:0 0 12px rgba(0,255,65,.2);}
.lobbyBtn{background:transparent;border:1px solid var(--red);color:var(--red);
  font-family:'Share Tech Mono',monospace;font-size:.9rem;
  padding:.8em 0;width:min(260px,80vw);letter-spacing:.2em;
  text-transform:uppercase;transition:all .2s;cursor:pointer;}
.lobbyBtn:active{background:var(--red);color:#000;}
#lobbyStatus{margin-top:1.2rem;font-size:.65rem;color:rgba(0,255,65,.5);
  letter-spacing:.2em;min-height:1.2em;text-align:center;}

/* WAITING */
#waiting{position:fixed;inset:0;display:none;flex-direction:column;
  align-items:center;justify-content:center;background:#000;z-index:99;padding:1rem;}
.wTitle{font-family:'Creepster',cursive;font-size:2.2rem;color:var(--red);
  text-shadow:0 0 20px var(--red);margin-bottom:.5rem;}
.wSub{font-size:.65rem;letter-spacing:.3em;color:rgba(0,255,65,.45);margin-bottom:1.5rem;}
.plist{border:1px solid rgba(0,255,65,.2);padding:1rem 1.5rem;min-width:min(300px,80vw);}
.prow{display:flex;align-items:center;gap:.8rem;padding:.4rem 0;
  border-bottom:1px solid rgba(0,255,65,.08);font-size:.8rem;}
.pdot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green);}
.pdot.off{background:#222;box-shadow:none;}
#cdNum{font-family:'Creepster',cursive;font-size:5rem;color:var(--red);
  text-shadow:0 0 30px var(--red);display:none;margin-top:1rem;}
#roleDisp{font-size:.75rem;letter-spacing:.2em;color:rgba(0,255,65,.6);margin-top:.8rem;}

/* CANVAS */
#gc{position:fixed;inset:0;display:none;touch-action:none;}

/* HUD */
#hud{position:fixed;inset:0;pointer-events:none;z-index:50;display:none;}
/* top */
#topHud{position:absolute;top:0;left:0;right:0;height:52px;
  background:linear-gradient(180deg,rgba(0,0,0,.75) 0%,transparent 100%);
  display:flex;align-items:center;justify-content:space-between;padding:0 .8rem;}
.hpanel{background:rgba(0,0,0,.6);border:1px solid rgba(0,255,65,.18);
  padding:.3rem .6rem;font-size:.6rem;letter-spacing:.08em;white-space:nowrap;}
.hpanel.red{border-color:rgba(255,0,51,.25);}
#gameTimer{font-size:1rem;color:var(--red);}
/* tasks */
#taskBox{position:absolute;right:.6rem;top:56px;
  background:rgba(0,0,0,.75);border:1px solid rgba(0,255,65,.18);
  border-left:3px solid var(--green);padding:.6rem .8rem;min-width:160px;max-width:180px;}
.tTitle{font-size:.55rem;letter-spacing:.15em;color:rgba(0,255,65,.5);margin-bottom:.5rem;}
.tItem{display:flex;align-items:center;gap:.4rem;padding:.18rem 0;
  font-size:.55rem;color:rgba(0,255,65,.65);}
.tItem.done{color:rgba(0,255,65,.25);text-decoration:line-through;}
.tck{width:8px;height:8px;border:1px solid rgba(0,255,65,.4);flex-shrink:0;}
.tItem.done .tck{background:var(--green);}
#taskProg{margin-top:.4rem;font-size:.5rem;color:rgba(0,255,65,.35);}
/* interact */
#iPrompt{position:absolute;bottom:34%;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,.8);border:1px solid var(--green);
  padding:.35rem 1rem;font-size:.65rem;letter-spacing:.15em;
  display:none;animation:pulseA 1s infinite;pointer-events:none;}
@keyframes pulseA{0%,100%{opacity:1}50%{opacity:.4}}
/* minimap */
#mmap{position:absolute;bottom:5rem;left:.6rem;width:110px;height:110px;
  background:rgba(0,0,0,.8);border:1px solid rgba(0,255,65,.25);overflow:hidden;}
#mmCv{width:100%;height:100%;}
/* blood */
#blood{position:fixed;inset:0;pointer-events:none;z-index:600;display:none;
  background:radial-gradient(ellipse at center,transparent 30%,rgba(180,0,0,.7) 100%);}

/* NOTIFICATIONS */
#notifs{position:fixed;top:3.5rem;left:50%;transform:translateX(-50%);
  z-index:700;display:flex;flex-direction:column;gap:.4rem;align-items:center;pointer-events:none;}
.notif{background:rgba(0,0,0,.92);border:1px solid var(--red);color:var(--red);
  padding:.35rem 1rem;font-size:.7rem;letter-spacing:.15em;white-space:nowrap;
  box-shadow:0 0 16px rgba(255,0,51,.3);font-family:'Creepster',cursive;font-size:.9rem;
  animation:nIn .3s ease,nOut .5s 2.5s ease forwards;}
.notif.g{border-color:var(--green);color:var(--green);box-shadow:0 0 16px rgba(0,255,65,.3);}
.notif.y{border-color:var(--yellow);color:var(--yellow);box-shadow:0 0 16px rgba(255,204,0,.3);}
@keyframes nIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
@keyframes nOut{to{opacity:0;transform:translateY(-8px)}}

/* MOBILE CONTROLS */
#mobileCtrl{position:fixed;inset:0;pointer-events:none;z-index:60;display:none;}

/* LEFT - Joystick */
#joyZone{position:absolute;bottom:1rem;left:1rem;width:130px;height:130px;pointer-events:all;}
#joyBase{width:100%;height:100%;border-radius:50%;
  background:rgba(0,255,65,.04);border:2px solid rgba(0,255,65,.2);}
#joyThumb{width:44px;height:44px;border-radius:50%;
  background:rgba(0,255,65,.25);border:2px solid var(--green);
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  box-shadow:0 0 12px rgba(0,255,65,.4);}

/* RIGHT - Look zone */
#lookZone{position:absolute;top:0;bottom:0;left:160px;right:180px;pointer-events:all;}

/* RIGHT side buttons */
#rightBtns{position:absolute;right:.6rem;bottom:1rem;
  display:flex;flex-direction:column;gap:.5rem;align-items:center;pointer-events:all;}
.ctrlBtn{width:56px;height:56px;border-radius:50%;background:rgba(0,0,0,.7);
  border:2px solid rgba(0,255,65,.3);display:flex;align-items:center;justify-content:center;
  font-size:1.4rem;pointer-events:all;transition:all .15s;-webkit-tap-highlight-color:transparent;}
.ctrlBtn:active{background:rgba(0,255,65,.15);border-color:var(--green);}
#flashBtn{border-color:var(--yellow);font-size:1.5rem;}
#flashBtn.on{background:rgba(255,204,0,.15);border-color:var(--yellow);
  box-shadow:0 0 16px rgba(255,204,0,.5);}
#sprintBtn{border-color:rgba(0,255,65,.3);}
#sprintBtn.active{background:rgba(0,255,65,.15);border-color:var(--green);}
#interactBtn{border-color:var(--green);}
#interactBtn:active{background:rgba(0,255,65,.2);}

/* OVERLAY */
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.93);z-index:800;
  display:none;flex-direction:column;align-items:center;justify-content:center;gap:.8rem;}
.ovTitle{font-family:'Creepster',cursive;font-size:clamp(2rem,8vw,4rem);
  text-shadow:0 0 40px currentColor;text-align:center;padding:0 1rem;}
.ovSub{font-size:.7rem;letter-spacing:.3em;opacity:.6;text-align:center;}
.ovBtn{background:transparent;border:1px solid var(--red);color:var(--red);
  font-family:'Share Tech Mono',monospace;font-size:.85rem;
  padding:.7em 2em;margin-top:1rem;letter-spacing:.2em;cursor:pointer;}
.ovBtn:active{background:var(--red);color:#000;}

/* LOADING BAR */
#lbar{position:fixed;bottom:0;left:0;height:2px;background:var(--red);
  width:0%;transition:width .3s;z-index:9998;box-shadow:0 0 8px var(--red);}

/* TASK PROGRESS MINI */
#tprogBar{position:absolute;bottom:0;left:0;right:0;height:3px;background:rgba(0,255,65,.1);}
#tprogFill{height:100%;background:var(--green);width:0%;transition:width .5s;
  box-shadow:0 0 6px var(--green);}

/* Flashlight visual on HUD (hand) */
#handCanvas{position:fixed;bottom:0;right:0;width:220px;height:180px;
  pointer-events:none;z-index:55;display:none;opacity:.9;}
</style>
</head>
<body>

<div id="portrait">
  <div class="ri">ğŸ“±</div>
  <p>TELEFONU YATAY Ã‡EVÄ°R</p>
</div>

<div id="scan"></div>
<div id="vig"></div>
<div id="blood"></div>
<div id="lbar"></div>

<!-- â•â•â• LOBBY â•â•â• -->
<div id="lobby">
  <div class="logo">DARKROOM</div>
  <div class="sub">KARANLIÄA HOÅ GELDÄ°N</div>
  <input class="ninput" id="nameInput" type="text" placeholder="Ä°SMÄ°NÄ° GÄ°R..." maxlength="14" autocomplete="off" spellcheck="false">
  <div class="mode-row">
    <button class="modeBtn active" id="mSolo" onclick="selectMode('solo')">âš¡ TEK</button>
    <button class="modeBtn" id="mMulti" onclick="selectMode('multi')">ğŸ‘¥ Ã‡OKLU</button>
  </div>
  <button class="lobbyBtn" onclick="startLobby()">[ OYUNA GÄ°R ]</button>
  <div id="lobbyStatus">SUNUCU KONTROL EDÄ°LÄ°YOR...</div>
</div>

<!-- â•â•â• WAITING (multi) â•â•â• -->
<div id="waiting">
  <div class="wTitle">BEKLEME ODASI</div>
  <div class="wSub" id="wSub">0/5 OYUNCU</div>
  <div class="plist" id="plist"></div>
  <div id="cdNum"></div>
  <div id="roleDisp"></div>
</div>

<!-- â•â•â• GAME â•â•â• -->
<canvas id="gc"></canvas>

<!-- HUD -->
<div id="hud">
  <div id="topHud">
    <div class="hpanel">
      <div id="myNameHud" style="color:var(--green);font-size:.65rem;"></div>
      <div id="myRoleHud" style="font-size:.5rem;opacity:.6;margin-top:.1rem;"></div>
    </div>
    <div class="hpanel" style="text-align:center;">
      <div id="gameTimer">10:00</div>
      <div style="font-size:.45rem;opacity:.5;letter-spacing:.15em;">KALAN</div>
    </div>
    <div class="hpanel red" style="text-align:right;">
      <div style="font-size:.5rem;opacity:.5;margin-bottom:.1rem;">OYUNCULAR</div>
      <div id="pcount" style="color:var(--red);font-size:.65rem;">-</div>
    </div>
  </div>
  <div id="taskBox">
    <div class="tTitle">// GÃ–REVLER</div>
    <div id="tItems"></div>
    <div id="taskProg">0 / 5</div>
    <div id="tprogBar"><div id="tprogFill"></div></div>
  </div>
  <div id="iPrompt">[ DOKUN ] ETKÄ°LEÅ</div>
  <div id="mmap"><canvas id="mmCv" width="110" height="110"></canvas></div>
</div>

<!-- HAND + FLASHLIGHT -->
<canvas id="handCanvas"></canvas>

<!-- NOTIFS -->
<div id="notifs"></div>

<!-- MOBILE CONTROLS -->
<div id="mobileCtrl">
  <div id="joyZone">
    <div id="joyBase"><div id="joyThumb"></div></div>
  </div>
  <div id="lookZone"></div>
  <div id="rightBtns">
    <button class="ctrlBtn" id="flashBtn" ontouchstart="toggleFlash()" style="font-size:1.5rem;">ğŸ”¦</button>
    <button class="ctrlBtn" id="sprintBtn"
      ontouchstart="setSprint(true)" ontouchend="setSprint(false)">ğŸ’¨</button>
    <button class="ctrlBtn" id="interactBtn" ontouchstart="tryInteract()">âš¡</button>
  </div>
</div>

<!-- OVERLAY -->
<div id="overlay">
  <div class="ovTitle" id="ovTitle"></div>
  <div class="ovSub" id="ovSub"></div>
  <button class="ovBtn" onclick="location.reload()">[ YENÄ°DEN OYNA ]</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REDIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const REDIS_URL   = "https://informed-hen-11704.upstash.io";
const REDIS_TOKEN = "AS24AAIncDFkZWFiODQ5MTkxNTk0MTAxODk1NWY1Y2RlOTRjYTU3OHAxMTE3MDQ";

async function rcmd(...args){
  try{
    const r=await fetch(`${REDIS_URL}/${args.map(a=>encodeURIComponent(a)).join('/')}`,
      {headers:{Authorization:`Bearer ${REDIS_TOKEN}`}});
    return (await r.json()).result;
  }catch{return null;}
}
async function hset(k,f,v){return rcmd('hset',k,f,JSON.stringify(v));}
async function hget(k,f){const v=await rcmd('hget',k,f);try{return v?JSON.parse(v):null;}catch{return null;}}
async function hgetall(k){
  const d=await rcmd('hgetall',k);if(!d)return{};
  const o={};for(let i=0;i<d.length;i+=2){try{o[d[i]]=JSON.parse(d[i+1]);}catch{o[d[i]]=d[i+1];}}return o;
}
async function hdel(k,f){return rcmd('hdel',k,f);}
async function lpush(k,v){return rcmd('lpush',k,JSON.stringify(v));}
async function lrange(k,s,e){
  const d=await rcmd('lrange',k,s,e);if(!d)return[];
  return d.map(v=>{try{return JSON.parse(v);}catch{return null;}}).filter(Boolean);
}
async function ltrim(k,s,e){return rcmd('ltrim',k,s,e);}
async function rset(k,v){return rcmd('set',k,JSON.stringify(v));}
async function rget(k){const v=await rcmd('get',k);try{return v?JSON.parse(v):null;}catch{return null;}}
async function rsetex(k,s,v){return rcmd('setex',k,s,JSON.stringify(v));}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GLOBAL STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ROOM   = 'dr:players';
const EVENTS = 'dr:events';
const STATE  = 'dr:state';
const MAX_P  = 5;
const GAME_T = 600;

let myId='', myName='', myRole=null, gameMode='solo';
let gamePhase='lobby';
let players={}, gameState=null;
let pollTimer=null, gameTimer=null;
let timeLeft=GAME_T, lastEvTime=0;

let tasks=[], taskObjects=[], walls=[];
let scene, camera, renderer, clock, raycaster;
let flashOn=false, flashLight=null;
let sprinting=false;
let playerMeshes={};
let nearTask=null;
let frameN=0;
let handCtx=null;
let handAnim=0;

// BOTS (solo)
let bots=[];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOBBY LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selMode='solo';
function selectMode(m){
  selMode=m;
  document.getElementById('mSolo').classList.toggle('active',m==='solo');
  document.getElementById('mMulti').classList.toggle('active',m==='multi');
}

function lbar(p){document.getElementById('lbar').style.width=p+'%';}

async function startLobby(){
  const n=document.getElementById('nameInput').value.trim();
  if(!n){showNotif('Ä°SMÄ°NÄ° GÄ°R!');return;}
  myName=n; myId='p'+Math.random().toString(36).slice(2,9);
  gameMode=selMode;

  document.getElementById('lobbyStatus').textContent='BAÄLANIYOR...';
  lbar(40);

  if(gameMode==='solo'){
    lbar(100);
    setTimeout(()=>{
      document.getElementById('lobby').style.display='none';
      myRole='runner';
      launchGame({phase:'playing',startTime:Date.now(),hunterIds:[],tasks:generateTasks(),soloMode:true});
    },600);
    return;
  }

  // Multi
  const pd={id:myId,name:myName,role:null,x:0,y:0,z:0,rx:0,alive:true,fl:false,joinedAt:Date.now()};
  await hset(ROOM,myId,pd);
  lbar(80);
  players=await hgetall(ROOM);
  lbar(100);

  document.getElementById('lobby').style.display='none';
  document.getElementById('waiting').style.display='flex';
  gamePhase='waiting';
  startPoll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POLLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startPoll(){pollTimer=setInterval(poll,1200);poll();}

async function poll(){
  if(gamePhase==='ended')return;
  // heartbeat
  const me=await hget(ROOM,myId);
  if(me){
    me.joinedAt=Date.now();
    if(gamePhase==='playing'&&camera){
      me.x=camera.position.x;me.z=camera.position.z;me.rx=camera.rotation.y;
      me.fl=flashOn;
    }
    await hset(ROOM,myId,me);
  }
  players=await hgetall(ROOM);
  if(gamePhase==='waiting'){updateWaiting();checkStart();}
  else if(gamePhase==='playing'){updateNetPlayers();checkEvents();}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WAITING ROOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateWaiting(){
  const arr=Object.values(players);
  const ct=arr.length;
  document.getElementById('wSub').textContent=`${ct}/5 OYUNCU Â· ${ct<2?'EN AZ 2 GEREKLÄ°':'HAZIR!'}`;
  const pl=document.getElementById('plist');pl.innerHTML='';
  for(let i=0;i<MAX_P;i++){
    const pd=arr[i];
    const row=document.createElement('div');row.className='prow';
    if(pd){
      row.innerHTML=`<div class="pdot"></div>
        <span style="flex:1;color:${pd.id===myId?'var(--green)':'rgba(0,255,65,.7)'}">${pd.name}${pd.id===myId?' â—€':''}</span>`;
    }else{
      row.innerHTML=`<div class="pdot off"></div><span style="color:#222">BoÅŸ</span>`;
    }
    pl.appendChild(row);
  }
}

let cdRunning=false;
async function checkStart(){
  const arr=Object.values(players);
  if(arr.length<2)return;
  const st=await rget(STATE);
  if(st&&st.phase==='playing'){
    myRole=st.hunterIds.includes(myId)?'hunter':'runner';
    document.getElementById('waiting').style.display='none';
    launchGame(st);return;
  }
  const sorted=arr.sort((a,b)=>a.joinedAt-b.joinedAt);
  if(sorted[0].id!==myId||cdRunning)return;
  cdRunning=true;
  const cdEl=document.getElementById('cdNum');cdEl.style.display='block';
  let cd=5;
  const t=setInterval(async()=>{
    cdEl.textContent=cd;
    if(cd<=0){
      clearInterval(t);
      const fp=await hgetall(ROOM);
      const pa=Object.values(fp).sort(()=>Math.random()-.5);
      const hid=[pa[0].id];
      for(const p of pa){p.role=hid.includes(p.id)?'hunter':'runner';await hset(ROOM,p.id,p);}
      const ns={phase:'playing',startTime:Date.now(),hunterIds:hid,tasks:generateTasks()};
      await rsetex(STATE,700,ns);
      gameState=ns;myRole=hid.includes(myId)?'hunter':'runner';
      document.getElementById('waiting').style.display='none';
      launchGame(ns);
    }cd--;
  },1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TASKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateTasks(){
  return[
    {id:'t1',name:'ELEKTRÄ°ÄÄ° AÃ‡',done:false,x:14,z:-8,color:0x00ff41},
    {id:'t2',name:'ANAHTARI BUL',done:false,x:-13,z:11,color:0xffcc00},
    {id:'t3',name:'PENSEYÄ° AL',done:false,x:8,z:17,color:0xff6600},
    {id:'t4',name:'TELÄ° KES (Pense lazÄ±m)',done:false,x:-17,z:-14,color:0xff0066,needsItem:'t3'},
    {id:'t5',name:'Ã‡IKIÅ KAPISI (4 gÃ¶rev lazÄ±m)',done:false,x:0,z:-24,color:0x4488ff,needsAll:4},
  ];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LAUNCH GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function launchGame(state){
  if(gamePhase==='playing')return;
  gamePhase='playing';
  gameState=state;
  tasks=JSON.parse(JSON.stringify(state.tasks||generateTasks()));

  document.getElementById('gc').style.display='block';
  document.getElementById('hud').style.display='block';
  document.getElementById('mobileCtrl').style.display='block';
  document.getElementById('handCanvas').style.display='block';

  document.getElementById('myNameHud').textContent=myName;
  document.getElementById('myRoleHud').textContent=myRole==='hunter'?'[ AVCI ]':'[ KAÃ‡AK ]';

  if(state.soloMode){
    showNotif('ğŸ‘» BOTLARDAN KAÃ‡MAYA Ã‡ALIÅ!','y');
  }else{
    showNotif(myRole==='hunter'?'ğŸ”´ AVCI OLDUN! YAKALA!':'ğŸŸ¢ KAÃ‡AK OLDUN! GÃ–REVLERÄ° TAM.','g');
  }

  initThree(state);
  updateTaskHUD();
  startGameTimer();
  if(state.soloMode)spawnBots();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THREE.JS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initThree(state){
  const canvas=document.getElementById('gc');
  renderer=new THREE.WebGLRenderer({canvas,antialias:false,powerPreference:'low-power'});
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,1.5));
  renderer.setSize(window.innerWidth,window.innerHeight);
  renderer.shadowMap.enabled=true;
  renderer.shadowMap.type=THREE.BasicShadowMap;

  scene=new THREE.Scene();
  const fc=myRole==='hunter'?new THREE.Color(0x0d0003):new THREE.Color(0x000d05);
  scene.fog=new THREE.FogExp2(fc,0.09);
  scene.background=fc;

  camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.05,80);
  camera.position.set(myRole==='hunter'?3:-3,1.7,0);
  scene.add(camera);

  clock=new THREE.Clock();
  raycaster=new THREE.Raycaster();

  buildMap();
  buildLights();
  buildTaskObjects();
  initHandCanvas();
  initControls();
  animate();

  window.addEventListener('resize',()=>{
    camera.aspect=window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth,window.innerHeight);
  });
}

// â”€â”€ MAP â”€â”€
function buildMap(){
  // Floor
  const flG=new THREE.PlaneGeometry(70,70);
  const flM=new THREE.MeshLambertMaterial({color:0x080808});
  const fl=new THREE.Mesh(flG,flM);fl.rotation.x=-Math.PI/2;fl.receiveShadow=true;scene.add(fl);
  // Ceiling
  const ceG=new THREE.PlaneGeometry(70,70);
  const ceM=new THREE.MeshLambertMaterial({color:0x040404});
  const ce=new THREE.Mesh(ceG,ceM);ce.rotation.x=Math.PI/2;ce.position.y=4;scene.add(ce);

  const wM=new THREE.MeshLambertMaterial({color:0x111111});
  function wall(x,z,w,d,h=4){
    const m=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),wM);
    m.position.set(x,h/2,z);m.castShadow=true;m.receiveShadow=true;
    scene.add(m);walls.push(m);
  }
  // Outer
  wall(0,-30,60,.5);wall(0,30,60,.5);wall(-30,0,.5,60);wall(30,0,.5,60);
  // Inner maze
  wall(10,-10,.5,14);wall(-10,10,.5,14);
  wall(5,5,14,.5);wall(-5,-5,14,.5);
  wall(20,-15,.5,10);wall(-20,15,.5,10);
  wall(15,5,10,.5);wall(-15,-5,10,.5);
  wall(0,14,18,.5);wall(0,-14,18,.5);
  wall(24,0,.5,18);wall(-24,0,.5,18);
  wall(18,18,.5,8);wall(-18,-18,.5,8);
  wall(18,-18,8,.5);wall(-18,18,8,.5);
  wall(7,-20,.5,10);wall(-7,20,.5,10);
  // Debris
  const dM=new THREE.MeshLambertMaterial({color:0x0e0e0e});
  for(let i=0;i<18;i++){
    const m=new THREE.Mesh(new THREE.BoxGeometry(.5+Math.random()*1.5,.4+Math.random()*1.2,.5+Math.random()*1.2),dM);
    m.position.set((Math.random()-.5)*50,.3,(Math.random()-.5)*50);
    m.rotation.y=Math.random()*Math.PI;m.castShadow=true;scene.add(m);walls.push(m);
  }
}

// â”€â”€ LIGHTS â”€â”€
function buildLights(){
  scene.add(new THREE.AmbientLight(myRole==='hunter'?0x110005:0x001108,.25));
  // Flashlight attached to camera
  flashLight=new THREE.SpotLight(0xffffff,0,20,Math.PI/7,.6,1.8);
  flashLight.castShadow=false;
  camera.add(flashLight);
  flashLight.target.position.set(0,0,-1);
  camera.add(flashLight.target);
  // Some broken ceiling lights
  [[8,-8],[- 8,8],[20,20],[-20,-20],[0,0],[-15,15],[15,-15]].forEach(([x,z])=>{
    if(Math.random()>.35){
      const pt=new THREE.PointLight(0x002211,.4,9);
      pt.position.set(x,3.7,z);scene.add(pt);
    }
  });
}

// â”€â”€ TASK OBJECTS â”€â”€
function buildTaskObjects(){
  tasks.forEach(task=>{
    const g=new THREE.Group();g.position.set(task.x,0,task.z);
    // base box
    const bm=new THREE.MeshLambertMaterial({color:task.color,emissive:new THREE.Color(task.color).multiplyScalar(.15)});
    const bk=new THREE.Mesh(new THREE.BoxGeometry(.6,.6,.6),bm);bk.position.y=.5;bk.castShadow=true;g.add(bk);
    // glow sphere
    const gm=new THREE.MeshLambertMaterial({color:task.color,emissive:new THREE.Color(task.color).multiplyScalar(.5)});
    const gs=new THREE.Mesh(new THREE.SphereGeometry(.12,8,8),gm);gs.position.y=1.4;gs.name='glow';g.add(gs);
    // point light
    const pl=new THREE.PointLight(task.color,.8,4);pl.position.y=1.4;g.add(pl);
    g.userData={taskId:task.id,taskName:task.name};
    scene.add(g);taskObjects.push(g);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MINECRAFT BLOCK PLAYER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function createBlockPlayer(isHunter){
  const g=new THREE.Group();
  const skin=isHunter?0xcc0022:0x2244cc;
  const skinM=new THREE.MeshLambertMaterial({color:skin});
  const faceM=new THREE.MeshLambertMaterial({color:isHunter?0xaa2222:0x3355aa});
  const bodyM=new THREE.MeshLambertMaterial({color:isHunter?0x880011:0x112288});
  const legM =new THREE.MeshLambertMaterial({color:0x222244});
  const armM =new THREE.MeshLambertMaterial({color:skin});

  // Head
  const head=new THREE.Mesh(new THREE.BoxGeometry(.5,.5,.5),skinM);head.position.y=1.65;head.castShadow=true;
  // Face detail
  const face=new THREE.Mesh(new THREE.BoxGeometry(.5,.25,.02),faceM);face.position.set(0,1.65,.26);
  // Body
  const body=new THREE.Mesh(new THREE.BoxGeometry(.45,.6,.25),bodyM);body.position.y=1.1;body.castShadow=true;
  // Left arm
  const larm=new THREE.Mesh(new THREE.BoxGeometry(.2,.55,.2),armM);larm.position.set(-.33,1.08,0);larm.castShadow=true;
  // Right arm (holding flashlight)
  const rarm=new THREE.Mesh(new THREE.BoxGeometry(.2,.55,.2),armM);rarm.position.set(.33,1.08,0);rarm.castShadow=true;
  // Flashlight in right hand
  const flGeo=new THREE.CylinderGeometry(.05,.07,.35,8);
  const flMat=new THREE.MeshLambertMaterial({color:0x888888,emissive:0x111111});
  const flMesh=new THREE.Mesh(flGeo,flMat);
  flMesh.rotation.z=Math.PI/2;flMesh.position.set(.55,1.05,.18);flMesh.name='flashMesh';
  // Flashlight lens
  const lens=new THREE.Mesh(new THREE.CircleGeometry(.05,8),new THREE.MeshLambertMaterial({color:0xffffcc,emissive:0x888833}));
  lens.position.set(.73,1.05,.18);lens.rotation.z=Math.PI/2;lens.name='flashLens';
  // Left leg
  const lleg=new THREE.Mesh(new THREE.BoxGeometry(.2,.6,.2),legM);lleg.position.set(-.12,.35,0);
  // Right leg
  const rleg=new THREE.Mesh(new THREE.BoxGeometry(.2,.6,.2),legM);rleg.position.set(.12,.35,0);

  [head,face,body,larm,rarm,flMesh,lens,lleg,rleg].forEach(m=>g.add(m));

  // Nametag
  g.userData.lleg=lleg;g.userData.rleg=rleg;
  g.userData.larm=larm;g.userData.rarm=rarm;
  return g;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HAND CANVAS (FP flashlight view)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initHandCanvas(){
  const hc=document.getElementById('handCanvas');
  hc.width=220;hc.height=180;
  handCtx=hc.getContext('2d');
}

function drawHand(){
  if(!handCtx)return;
  const c=handCtx;const W=220,H=180;
  c.clearRect(0,0,W,H);
  // Arm (first person right hand)
  c.save();
  // Bob
  const bob=Math.sin(Date.now()*.003)*3;
  c.translate(0,bob);
  // Sleeve
  c.fillStyle='#1a1a2e';
  c.fillRect(130,100,90,H);
  // Hand skin
  c.fillStyle='#c68642';
  c.fillRect(135,80,60,90);
  // Fingers
  c.fillStyle='#b5763a';
  for(let i=0;i<4;i++){c.fillRect(138+i*14,68,11,20);}
  // Flashlight body
  c.fillStyle='#555555';
  c.beginPath();c.roundRect(155,55,28,110,4);c.fill();
  c.fillStyle='#444444';
  c.fillRect(158,58,22,6);
  // Lens glow
  if(flashOn){
    const gr=c.createRadialGradient(169,55,0,169,55,22);
    gr.addColorStop(0,'rgba(255,255,200,.95)');
    gr.addColorStop(.4,'rgba(255,255,150,.6)');
    gr.addColorStop(1,'rgba(255,255,100,0)');
    c.fillStyle=gr;c.beginPath();c.arc(169,55,22,0,Math.PI*2);c.fill();
    // Lens circle
    c.fillStyle='rgba(255,255,200,.9)';
    c.beginPath();c.arc(169,57,9,0,Math.PI*2);c.fill();
  }else{
    c.fillStyle='#222233';
    c.beginPath();c.arc(169,57,9,0,Math.PI*2);c.fill();
  }
  // Button on flashlight
  c.fillStyle=flashOn?'#ffff00':'#333333';
  c.beginPath();c.arc(169,145,6,0,Math.PI*2);c.fill();
  c.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONTROLS (Touch)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let joyX=0,joyY=0,lookDX=0,lookDY=0;
let camYaw=0,camPitch=0;
let joyActive=false,joyOrigin={x:0,y:0};
let lookActive=false,lookLast={x:0,y:0};

function initControls(){
  const jz=document.getElementById('joyZone');
  const lz=document.getElementById('lookZone');
  const thumb=document.getElementById('joyThumb');
  let joyTouchId=null,lookTouchId=null;

  function onTS(e){
    e.preventDefault();
    for(const t of e.changedTouches){
      const r=jz.getBoundingClientRect();
      if(t.clientX>=r.left&&t.clientX<=r.right&&t.clientY>=r.top&&t.clientY<=r.bottom){
        if(joyTouchId===null){joyTouchId=t.identifier;joyOrigin={x:t.clientX,y:t.clientY};}
      }else if(!isButtonTouch(t)){
        if(lookTouchId===null){lookTouchId=t.identifier;lookLast={x:t.clientX,y:t.clientY};}
      }
    }
  }
  function onTM(e){
    e.preventDefault();
    for(const t of e.changedTouches){
      if(t.identifier===joyTouchId){
        const dx=t.clientX-joyOrigin.x,dy=t.clientY-joyOrigin.y;
        const mx=45,len=Math.sqrt(dx*dx+dy*dy);
        joyX=Math.max(-1,Math.min(1,dx/mx));joyY=Math.max(-1,Math.min(1,dy/mx));
        const cx=Math.max(-mx,Math.min(mx,dx)),cy=Math.max(-mx,Math.min(mx,dy));
        thumb.style.transform=`translate(calc(-50% + ${cx}px),calc(-50% + ${cy}px))`;
      }
      if(t.identifier===lookTouchId){
        const ddx=t.clientX-lookLast.x,ddy=t.clientY-lookLast.y;
        camYaw-=ddx*.004;camPitch-=ddy*.004;
        camPitch=Math.max(-1.1,Math.min(1.1,camPitch));
        lookLast={x:t.clientX,y:t.clientY};
      }
    }
  }
  function onTE(e){
    e.preventDefault();
    for(const t of e.changedTouches){
      if(t.identifier===joyTouchId){joyTouchId=null;joyX=0;joyY=0;thumb.style.transform='translate(-50%,-50%)';}
      if(t.identifier===lookTouchId){lookTouchId=null;}
    }
  }
  function isButtonTouch(t){
    const rb=document.getElementById('rightBtns').getBoundingClientRect();
    return t.clientX>=rb.left&&t.clientX<=rb.right&&t.clientY>=rb.top&&t.clientY<=rb.bottom;
  }

  document.addEventListener('touchstart',onTS,{passive:false});
  document.addEventListener('touchmove',onTM,{passive:false});
  document.addEventListener('touchend',onTE,{passive:false});
}

function setSprint(v){
  sprinting=v;
  document.getElementById('sprintBtn').classList.toggle('active',v);
}

function toggleFlash(){
  flashOn=!flashOn;
  flashLight.intensity=flashOn?3:0;
  document.getElementById('flashBtn').classList.toggle('on',flashOn);
  showNotif(flashOn?'ğŸ”¦ FENER AÃ‡IK':'ğŸ”¦ FENER KAPALI',flashOn?'y':'');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COLLISION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function collides(x,z){
  const pb=new THREE.Box3(new THREE.Vector3(x-.28,0,z-.28),new THREE.Vector3(x+.28,4,z+.28));
  for(const w of walls){if(pb.intersectsBox(new THREE.Box3().setFromObject(w)))return true;}
  return false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOTS (solo mode)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnBots(){
  const positions=[[-5,5],[5,-5],[-8,-3],[8,3]];
  for(let i=0;i<Math.min(3,positions.length);i++){
    const bot={
      id:'bot'+i,name:'KARANLIK_'+i,role:'hunter',
      x:positions[i][0],z:positions[i][1],
      alive:true,fl:true,
      speed:.03,
      mesh:null,
      fl3:null,
    };
    const m=createBlockPlayer(true);
    m.position.set(bot.x,0,bot.z);scene.add(m);bot.mesh=m;
    // Bot flashlight
    const bfl=new THREE.SpotLight(0xff3300,2,12,Math.PI/8,.5,2);
    bfl.position.set(bot.x,1.5,bot.z);bfl.castShadow=false;scene.add(bfl);
    bot.fl3=bfl;bfl.target.position.set(bot.x,1.5,bot.z+1);scene.add(bfl.target);
    bots.push(bot);
  }
}

function updateBots(dt){
  for(const bot of bots){
    if(!bot.alive)continue;
    const dx=camera.position.x-bot.x,dz=camera.position.z-bot.z;
    const dist=Math.sqrt(dx*dx+dz*dz);
    if(dist<.01)continue;
    // Move toward player
    const nx=bot.x+(dx/dist)*bot.speed*(sprinting?1.3:1.8);
    const nz=bot.z+(dz/dist)*bot.speed*(sprinting?1.3:1.8);
    if(!collides(nx,bot.z))bot.x=nx;
    if(!collides(bot.x,nz))bot.z=nz;
    if(bot.mesh)bot.mesh.position.set(bot.x,0,bot.z);
    // Rotate toward player
    if(bot.mesh)bot.mesh.rotation.y=Math.atan2(dx,dz);
    // Flashlight
    if(bot.fl3){bot.fl3.position.set(bot.x,1.7,bot.z);bot.fl3.target.position.set(camera.position.x,1.5,camera.position.z);}
    // Leg walk anim
    if(bot.mesh&&dist>1){
      const t=Date.now()*.005;
      bot.mesh.userData.lleg&&(bot.mesh.userData.lleg.rotation.x=Math.sin(t)*0.6);
      bot.mesh.userData.rleg&&(bot.mesh.userData.rleg.rotation.x=-Math.sin(t)*0.6);
    }
    // Catch
    if(dist<1.2&&myRole==='runner'){
      showBlood();
      setTimeout(()=>endGame('YAKALANDIN!','r'),1500);
      bot.alive=false;
    }
  }
}

function showBlood(){
  const b=document.getElementById('blood');b.style.display='block';
  setTimeout(()=>b.style.display='none',600);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANIMATE LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function animate(){
  requestAnimationFrame(animate);
  const dt=clock.getDelta();frameN++;

  // Camera rotation
  camera.rotation.order='YXZ';
  camera.rotation.y=camYaw;camera.rotation.x=camPitch;

  // Movement
  const spd=sprinting?.1:.055;
  if(joyX!==0||joyY!==0){
    const angle=camYaw;
    const mx=( joyX*Math.cos(angle)+joyY*Math.sin(angle))*spd;
    const mz=(-joyX*Math.sin(angle)+joyY*Math.cos(angle))*spd;
    if(!collides(camera.position.x+mx,camera.position.z))camera.position.x+=mx;
    if(!collides(camera.position.x,camera.position.z+mz))camera.position.z+=mz;
  }
  camera.position.y=1.7;

  // Glow anim
  const t=clock.getElapsedTime();
  taskObjects.forEach(obj=>{
    const gl=obj.getObjectByName('glow');
    if(gl){gl.position.y=1.4+Math.sin(t*2+obj.position.x)*.08;gl.rotation.y+=dt*1.5;}
  });

  // Hand
  drawHand();

  // Near task
  if(frameN%3===0)checkNearTask();

  // Bots
  if(gameState?.soloMode)updateBots(dt);

  // Net players (every 6 frames)
  if(frameN%6===0&&!gameState?.soloMode)renderNetPlayers();

  // Minimap (every 12 frames)
  if(frameN%12===0)drawMinimap();

  renderer.render(scene,camera);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NET PLAYERS (multi)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderNetPlayers(){
  const arr=Object.values(players);
  for(const pd of arr){
    if(pd.id===myId||!pd.alive)continue;
    if(!playerMeshes[pd.id]){
      const m=createBlockPlayer(pd.role==='hunter');
      scene.add(m);playerMeshes[pd.id]=m;
      // flashlight for this player
      const fl=new THREE.SpotLight(pd.role==='hunter'?0xff2200:0xffffff,0,14,Math.PI/7,.5,2);
      fl.castShadow=false;scene.add(fl);fl.target.position.set(0,0,0);scene.add(fl.target);
      m.userData.fl3=fl;
    }
    const m=playerMeshes[pd.id];
    m.position.set(pd.x||0,0,pd.z||0);
    if(pd.rx!==undefined)m.rotation.y=(pd.rx||0)+Math.PI;
    // their flashlight
    const fl=m.userData.fl3;
    if(fl){
      fl.intensity=pd.fl?3:0;
      fl.position.set((pd.x||0),(1.7),(pd.z||0));
      const dir=new THREE.Vector3(Math.sin(pd.rx||0),0,Math.cos(pd.rx||0));
      fl.target.position.set((pd.x||0)+dir.x*5,1.5,(pd.z||0)+dir.z*5);
    }
    // walk anim
    const t=Date.now()*.005;
    const moving=Math.abs(pd.x||0)>.01;
    if(moving){
      m.userData.lleg&&(m.userData.lleg.rotation.x=Math.sin(t)*.5);
      m.userData.rleg&&(m.userData.rleg.rotation.x=-Math.sin(t)*.5);
    }
  }
  for(const [pid,m] of Object.entries(playerMeshes)){
    if(!players[pid]){if(m.userData.fl3){scene.remove(m.userData.fl3);scene.remove(m.userData.fl3.target);}scene.remove(m);delete playerMeshes[pid];}
  }
}

async function updateNetPlayers(){
  renderNetPlayers();
  // Hunter catches runner
  if(myRole==='hunter'){
    for(const pd of Object.values(players)){
      if(pd.role!=='runner'||!pd.alive)continue;
      const dx=(pd.x||0)-camera.position.x,dz=(pd.z||0)-camera.position.z;
      if(Math.sqrt(dx*dx+dz*dz)<1.5){
        pd.alive=false;await hset(ROOM,pd.id,pd);
        await lpush(EVENTS,{type:'caught',caughtId:pd.id,caughtName:pd.name,hunterName:myName,time:Date.now()});
        await ltrim(EVENTS,0,49);
        showBlood();showNotif(`YAKALADIM: ${pd.name}!`);
        const runners=Object.values(players).filter(p=>p.role==='runner');
        if(runners.every(p=>!p.alive))endGame('AVCI KAZANDI!','r');
      }
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INTERACT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkNearTask(){
  nearTask=null;
  const pr=document.getElementById('iPrompt');
  if(myRole!=='runner'){pr.style.display='none';return;}
  for(const obj of taskObjects){
    const dx=obj.position.x-camera.position.x,dz=obj.position.z-camera.position.z;
    if(Math.sqrt(dx*dx+dz*dz)<2.2){
      const task=tasks.find(t=>t.id===obj.userData.taskId);
      if(task&&!task.done){nearTask=obj.userData;pr.style.display='block';pr.textContent=`âš¡ ${task.name}`;return;}
    }
  }
  pr.style.display='none';
}

async function tryInteract(){
  if(!nearTask||myRole!=='runner')return;
  const task=tasks.find(t=>t.id===nearTask.taskId);
  if(!task||task.done)return;
  if(task.needsItem&&!tasks.find(t=>t.id===task.needsItem)?.done){
    showNotif(`Ã–NCE: ${tasks.find(t=>t.id===task.needsItem).name}`,'y');return;
  }
  if(task.needsAll){
    const dc=tasks.filter(t=>t.done).length;
    if(dc<task.needsAll){showNotif(`${dc}/${task.needsAll} GÃ–REV TAMAMLA`,'y');return;}
  }
  showNotif('âš™ YAPILIYOR...','y');
  await new Promise(r=>setTimeout(r,1200));
  task.done=true;
  // Dim glow
  const tObj=taskObjects.find(o=>o.userData.taskId===task.id);
  if(tObj){const gl=tObj.getObjectByName('glow');if(gl){gl.material.color.setHex(0x333333);gl.material.emissive?.setHex(0);const pl=tObj.children.find(c=>c.isLight);if(pl)pl.intensity=0;}}
  updateTaskHUD();
  showNotif('âœ“ '+task.name,'g');
  if(!gameState?.soloMode){
    await lpush(EVENTS,{type:'task_done',taskId:task.id,playerName:myName,time:Date.now()});
    await ltrim(EVENTS,0,49);
  }
  if(tasks.every(t=>t.done))endGame('KAÃ‡AKLAR KAZANDI! KAÃ‡TINIZ!','g');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EVENTS (multi)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function checkEvents(){
  const evs=await lrange(EVENTS,0,19);if(!evs)return;
  for(const ev of evs){
    if(!ev?.time||ev.time<=lastEvTime)continue;
    lastEvTime=ev.time;
    if(ev.type==='task_done'&&ev.playerName!==myName){
      const t=tasks.find(t=>t.id===ev.taskId);if(t){t.done=true;updateTaskHUD();showNotif(`${ev.playerName}: âœ“`,'g');}
    }
    if(ev.type==='caught'){
      if(ev.caughtId===myId){showBlood();setTimeout(()=>endGame('YAKALANDIN!','r'),1500);}
      else if(ev.hunterName!==myName)showNotif(`${ev.caughtName} YAKALANDI!`);
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MINIMAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawMinimap(){
  const cv=document.getElementById('mmCv');const ctx=cv.getContext('2d');
  const W=110,H=110;ctx.clearRect(0,0,W,H);
  ctx.fillStyle='rgba(0,0,0,.85)';ctx.fillRect(0,0,W,H);
  const sc=W/60;const ox=W/2-camera.position.x*sc,oz=H/2-camera.position.z*sc;
  ctx.fillStyle='#1a1a1a';
  for(const w of walls){
    const b=new THREE.Box3().setFromObject(w);
    ctx.fillRect(b.min.x*sc+ox,(b.min.z)*sc+oz,(b.max.x-b.min.x)*sc,(b.max.z-b.min.z)*sc);
  }
  tasks.forEach(t=>{
    ctx.fillStyle=t.done?'#333':'#00ff41';ctx.beginPath();
    ctx.arc(t.x*sc+ox,t.z*sc+oz,3,0,Math.PI*2);ctx.fill();
  });
  // bots
  bots.forEach(b=>{if(!b.alive)return;ctx.fillStyle='#ff0033';ctx.beginPath();ctx.arc(b.x*sc+ox,b.z*sc+oz,3,0,Math.PI*2);ctx.fill();});
  // net players
  Object.values(players).forEach(pd=>{
    if(pd.id===myId||!pd.alive||!pd.x)return;
    ctx.fillStyle=pd.role==='hunter'?'#ff0033':'#00ff41';
    ctx.beginPath();ctx.arc((pd.x||0)*sc+ox,(pd.z||0)*sc+oz,3,0,Math.PI*2);ctx.fill();
  });
  // me
  ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(W/2,H/2,4,0,Math.PI*2);ctx.fill();
  const ang=-camYaw;
  ctx.strokeStyle='#fff';ctx.lineWidth=1.5;ctx.beginPath();
  ctx.moveTo(W/2,H/2);ctx.lineTo(W/2+Math.sin(ang)*9,H/2-Math.cos(ang)*9);ctx.stroke();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TASK HUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateTaskHUD(){
  const c=document.getElementById('tItems');c.innerHTML='';
  const done=tasks.filter(t=>t.done).length;
  tasks.forEach(task=>{
    const el=document.createElement('div');el.className='tItem'+(task.done?' done':'');
    el.innerHTML=`<div class="tck"></div>${task.name}`;c.appendChild(el);
  });
  document.getElementById('taskProg').textContent=`${done} / ${tasks.length}`;
  document.getElementById('tprogFill').style.width=(done/tasks.length*100)+'%';
  document.getElementById('pcount').textContent=gameState?.soloMode?`1P`:`${Object.keys(players).length}/${MAX_P}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGameTimer(){
  gameTimer=setInterval(()=>{
    if(gamePhase!=='playing'){clearInterval(gameTimer);return;}
    const elapsed=Math.floor((Date.now()-(gameState?.startTime||Date.now()))/1000);
    timeLeft=Math.max(0,GAME_T-elapsed);
    const m=Math.floor(timeLeft/60).toString().padStart(2,'0');
    const s=(timeLeft%60).toString().padStart(2,'0');
    const el=document.getElementById('gameTimer');el.textContent=`${m}:${s}`;
    if(timeLeft<=60)el.style.color='var(--red)';
    if(timeLeft<=0){
      if(myRole==='runner')endGame('ZAMAN DOLDU! KAZANDIN!','g');
      else endGame('ZAMAN DOLDU! KAÃ‡AKLAR KURTULDU!','r');
    }
  },1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showNotif(msg,type=''){
  const el=document.createElement('div');
  el.className=`notif${type==='g'?' g':type==='y'?' y':''}`;
  el.textContent=msg;
  document.getElementById('notifs').appendChild(el);
  setTimeout(()=>el.remove(),3100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  END GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function endGame(msg,type){
  if(gamePhase==='ended')return;
  gamePhase='ended';
  clearInterval(pollTimer);clearInterval(gameTimer);
  if(!gameState?.soloMode)await hdel(ROOM,myId);
  const ov=document.getElementById('overlay');
  document.getElementById('ovTitle').textContent=msg;
  document.getElementById('ovTitle').style.color=type==='g'?'var(--green)':type==='y'?'var(--yellow)':'var(--red)';
  document.getElementById('ovSub').textContent=myRole==='hunter'?(type==='r'?'AVCI KAZANDI':'AVCI KAYBETTÄ°'):(type==='g'?'KAÃ‡AK KAZANDI':'KAÃ‡AK KAYBETTÄ°');
  ov.style.display='flex';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async()=>{
  try{const p=await rcmd('ping');document.getElementById('lobbyStatus').textContent=p==='PONG'?'âœ“ SUNUCU HAZIR':'âš  SUNUCU YOK';}
  catch{document.getElementById('lobbyStatus').textContent='âœ— BAÄLANTI YOK';}
})();
</script>
</body>
</html>
