<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Sƒ±nƒ±f 3D üìö</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { background:#000; font-family:'Segoe UI',sans-serif; overflow:hidden; touch-action:none; }

#canvas3d { position:fixed; inset:0; }

/* ===== LOBBY ===== */
#lobby {
  position:fixed; inset:0; z-index:100;
  background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  padding:24px;
}
.lobby-logo {
  font-size:3.5em; margin-bottom:4px;
  animation: float 3s ease-in-out infinite;
}
@keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
.lobby-title {
  font-size:1.8em; font-weight:900; color:#fff;
  letter-spacing:-1px; margin-bottom:4px;
  background: linear-gradient(135deg,#a78bfa,#f472b6);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
.lobby-sub { font-size:0.85em; color:#888; margin-bottom:32px; }

.card {
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:24px; padding:28px 24px;
  width:100%; max-width:360px;
  backdrop-filter:blur(20px);
  box-shadow: 0 25px 60px rgba(0,0,0,0.5);
}

.field { margin-bottom:16px; }
.field label {
  display:block; font-size:0.72em; font-weight:700;
  color:#a78bfa; text-transform:uppercase; letter-spacing:1.5px; margin-bottom:8px;
}
.field input {
  width:100%; padding:14px 16px;
  background:rgba(255,255,255,0.07);
  border:1.5px solid rgba(255,255,255,0.12);
  border-radius:14px; color:#fff;
  font-size:1em; font-weight:600; outline:none;
  transition:border-color 0.25s, background 0.25s;
}
.field input:focus { border-color:#a78bfa; background:rgba(167,139,250,0.1); }
.field input::placeholder { color:#555; }

.divider { text-align:center; color:#444; font-size:0.8em; margin:12px 0; position:relative; }
.divider::before,.divider::after {
  content:''; position:absolute; top:50%; width:42%; height:1px; background:#333;
}
.divider::before{left:0} .divider::after{right:0}

.btn {
  width:100%; padding:15px; border:none; border-radius:16px;
  font-size:1em; font-weight:800; cursor:pointer;
  transition:all 0.18s; letter-spacing:0.3px;
  margin-top:4px;
}
.btn:active{transform:scale(0.96)}
.btn-primary {
  background:linear-gradient(135deg,#7c3aed,#a855f7);
  color:#fff; box-shadow:0 6px 24px rgba(124,58,237,0.45);
}
.btn-secondary {
  background:linear-gradient(135deg,#0891b2,#06b6d4);
  color:#fff; box-shadow:0 6px 24px rgba(6,182,212,0.35);
}

/* ===== WAITING ===== */
#waiting {
  position:fixed; inset:0; z-index:100;
  background:linear-gradient(135deg,#0f0c29,#302b63,#24243e);
  display:none; flex-direction:column; align-items:center; justify-content:center;
  padding:24px;
}
.room-code {
  font-size:4em; font-weight:900; letter-spacing:10px;
  background:linear-gradient(135deg,#a78bfa,#f472b6);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  margin:12px 0;
}
.waiting-players { width:100%; max-width:320px; margin:16px 0; }
.p-slot {
  display:flex; align-items:center; gap:12px;
  padding:12px 16px; border-radius:14px;
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.08);
  margin-bottom:10px;
}
.p-dot { width:10px; height:10px; border-radius:50%; }
.p-dot.on { background:#22c55e; box-shadow:0 0 8px #22c55e; }
.p-dot.off { background:#333; }
.p-name { font-size:0.9em; font-weight:700; color:#ddd; }
.dots { display:flex; gap:6px; margin-top:16px; justify-content:center; }
.dots span {
  width:9px; height:9px; border-radius:50%; background:#7c3aed;
  animation:bop 1.2s infinite;
}
.dots span:nth-child(2){animation-delay:.2s}
.dots span:nth-child(3){animation-delay:.4s}
@keyframes bop{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-10px);opacity:1}}

/* ===== HUD ===== */
#hud {
  position:fixed; bottom:0; left:0; right:0; z-index:50;
  padding:12px 14px 20px;
  background:linear-gradient(transparent, rgba(0,0,0,0.92));
  pointer-events:none;
}
.hud-top {
  display:flex; align-items:center; gap:10px;
  margin-bottom:10px;
  pointer-events:none;
}
.danger-bar-wrap { flex:1; height:10px; background:rgba(255,255,255,0.1); border-radius:10px; overflow:hidden; }
.danger-bar { height:100%; border-radius:10px; background:#22c55e; transition:width 0.2s, background 0.3s; }
.score-lbl { font-size:0.8em; font-weight:800; color:#fbbf24; white-space:nowrap; }

.hud-btns { display:flex; gap:10px; pointer-events:all; }
.hbtn {
  flex:1; padding:16px 10px;
  border:none; border-radius:18px;
  font-size:1.05em; font-weight:800;
  cursor:pointer; transition:all 0.15s;
  position:relative; overflow:hidden;
  -webkit-tap-highlight-color:transparent;
  user-select:none;
}
.hbtn:active{transform:scale(0.94)}
.hbtn-talk {
  background:linear-gradient(135deg,#dc2626,#ef4444);
  color:#fff; box-shadow:0 6px 20px rgba(220,38,38,0.5);
}
.hbtn-poke {
  background:linear-gradient(135deg,#d97706,#f59e0b);
  color:#fff; box-shadow:0 6px 20px rgba(217,119,6,0.45);
}
.hbtn.disabled { opacity:0.5; pointer-events:none; }
.cd-txt {
  position:absolute; inset:0; display:flex;
  align-items:center; justify-content:center;
  background:rgba(0,0,0,0.55); font-size:0.9em;
  opacity:0; pointer-events:none;
}
.hbtn.disabled .cd-txt { opacity:1; }

/* ===== ALERTS ===== */
.alert-banner {
  position:fixed; top:16px; left:50%; transform:translateX(-50%) translateY(-100px);
  padding:10px 22px; border-radius:20px; font-weight:800; font-size:0.95em;
  z-index:200; transition:transform 0.35s cubic-bezier(0.34,1.56,0.64,1);
  white-space:nowrap; box-shadow:0 8px 30px rgba(0,0,0,0.4);
}
.alert-banner.show { transform:translateX(-50%) translateY(0); }
#alertTeacher { background:linear-gradient(135deg,#dc2626,#b91c1c); color:#fff; top:16px; }
#alertPoke { background:linear-gradient(135deg,#d97706,#f59e0b); color:#fff; top:70px; }

/* ===== CAUGHT ===== */
#caught {
  position:fixed; inset:0; z-index:300;
  background:rgba(0,0,0,0.93);
  display:none; flex-direction:column;
  align-items:center; justify-content:center;
  padding:30px;
}
.caught-emoji { font-size:5em; animation:wiggle 0.6s ease; }
@keyframes wiggle{0%,100%{transform:rotate(0)}25%{transform:rotate(-12deg)}75%{transform:rotate(12deg)}}
.caught-title { font-size:2.2em; font-weight:900; color:#ef4444; margin:12px 0 6px; }
.caught-score { font-size:1em; color:#888; margin-bottom:28px; }
.caught-score b { color:#fbbf24; font-size:1.4em; }
.caught-btns { display:flex; flex-direction:column; gap:10px; width:100%; max-width:280px; }

/* ===== GYRO TIP ===== */
#gyroTip {
  position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
  background:rgba(0,0,0,0.8); color:#fff; padding:16px 24px;
  border-radius:20px; font-size:0.9em; text-align:center;
  z-index:80; pointer-events:none; opacity:0;
  transition:opacity 0.5s;
}

#compass {
  position:fixed; top:14px; right:14px; z-index:60;
  width:44px; height:44px;
  background:rgba(0,0,0,0.55);
  border:1.5px solid rgba(255,255,255,0.15);
  border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:0.65em; color:#aaa; font-weight:700;
  flex-direction:column; line-height:1.2;
}
</style>
</head>
<body>

<!-- LOBBY -->
<div id="lobby">
  <div class="lobby-logo">üéí</div>
  <div class="lobby-title">Ders Zamanƒ±</div>
  <p class="lobby-sub">3D sƒ±nƒ±fta arkada≈üƒ±nla konu≈ü, yakalanma!</p>

  <div class="card">
    <div class="field">
      <label>ƒ∞smin</label>
      <input id="inName" type="text" placeholder="Adƒ±nƒ± gir..." maxlength="12">
    </div>
    <button class="btn btn-primary" onclick="createRoom()">üè´ Oda Olu≈ütur</button>

    <div class="divider">‚Äî ya da ‚Äî</div>

    <div class="field">
      <label>Oda Kodu</label>
      <input id="inCode" type="text" placeholder="Kodu gir..." maxlength="4" style="text-transform:uppercase;letter-spacing:4px;font-size:1.3em;text-align:center">
    </div>
    <button class="btn btn-secondary" onclick="joinRoom()">üö™ Odaya Katƒ±l</button>
  </div>
</div>

<!-- WAITING -->
<div id="waiting">
  <div style="font-size:0.8em;color:#666;text-transform:uppercase;letter-spacing:2px;">Oda Kodu</div>
  <div class="room-code" id="dispCode">----</div>
  <div style="font-size:0.85em;color:#555;margin-bottom:8px;">Arkada≈üƒ±na bu kodu g√∂nder</div>

  <div class="waiting-players" id="wPlayers"></div>

  <div class="dots"><span></span><span></span><span></span></div>
  <div style="font-size:0.8em;color:#555;margin-top:10px;" id="wMsg">Bekleniyor...</div>
</div>

<!-- 3D CANVAS -->
<canvas id="canvas3d"></canvas>

<!-- COMPASS -->
<div id="compass" style="display:none">
  <span id="cmpDir">K</span>
  <span id="cmpDeg">0¬∞</span>
</div>

<!-- HUD -->
<div id="hud" style="display:none">
  <div class="hud-top">
    <div style="font-size:0.75em;color:#aaa;font-weight:700;white-space:nowrap;">‚ö†Ô∏è TEHLƒ∞KE</div>
    <div class="danger-bar-wrap"><div class="danger-bar" id="dangerBar" style="width:0%"></div></div>
    <div class="score-lbl">‚≠ê <span id="scoreNum">0</span>s</div>
  </div>
  <div class="hud-btns">
    <button class="hbtn hbtn-talk" id="btnTalk"
      ontouchstart="startTalk(event)" ontouchend="stopTalk(event)"
      onmousedown="startTalk(event)" onmouseup="stopTalk(event)">
      üí¨ Konu≈ü
      <div class="cd-txt" id="talkCD"></div>
    </button>
    <button class="hbtn hbtn-poke" id="btnPoke" onclick="doPoke()">
      üëâ D√ºrt
      <div class="cd-txt" id="pokeCD"></div>
    </button>
  </div>
</div>

<!-- ALERTS -->
<div class="alert-banner" id="alertTeacher">üëÄ √ñƒüretmen bakƒ±yor! DUR!</div>
<div class="alert-banner" id="alertPoke">üëâ Seni d√ºrt√ºyor!</div>

<!-- GYRO TIP -->
<div id="gyroTip">üì± Telefonu √ßevirerek sƒ±nƒ±fa bak!</div>

<!-- CAUGHT -->
<div id="caught">
  <div class="caught-emoji">üò±</div>
  <div class="caught-title">YAKALANDIK!</div>
  <div class="caught-score">Toplam s√ºre: <b id="finalScore">0</b> saniye</div>
  <div class="caught-btns">
    <button class="btn btn-primary" onclick="restartGame()">üîÑ Tekrar Oyna</button>
    <button class="btn" style="background:rgba(255,255,255,0.08);color:#aaa" onclick="goLobby()">üè† Ana Men√º</button>
  </div>
</div>

<!-- THREE.JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>

// ===== REDIS =====
const R_URL   = "https://informed-hen-11704.upstash.io";
const R_TOKEN = "AS24AAIncDFkZWFiODQ5MTkxNTk0MTAxODk1NWY1Y2RlOTRjYTU3OHAxMTE3MDQ";

async function rGet(k) {
  try {
    const r = await fetch(`${R_URL}/get/${encodeURIComponent(k)}`,
      {headers:{Authorization:`Bearer ${R_TOKEN}`}});
    const d = await r.json();
    return d.result ? JSON.parse(d.result) : null;
  } catch { return null; }
}
async function rSet(k,v,ex=300) {
  try {
    await fetch(`${R_URL}/set/${encodeURIComponent(k)}/${encodeURIComponent(JSON.stringify(v))}?ex=${ex}`,
      {headers:{Authorization:`Bearer ${R_TOKEN}`}});
  } catch {}
}

// ===== STATE =====
let myId   = Math.random().toString(36).substr(2,8);
let myName = '';
let roomCode = '';
let isHost = false;
let players = {};
let gameOn = false;
let talking = false;
let danger  = 0;
let score   = 0;
let teacherWatching = false;
let pollInt = null;
let gameInt = null;
let seenEvts = new Set();

// ===== THREE SCENE =====
const canvas = document.getElementById('canvas3d');
const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);
scene.fog = new THREE.Fog(0x87CEEB, 20, 60);

const camera = new THREE.PerspectiveCamera(65, 1, 0.1, 100);
// Sit position: row 4, middle
camera.position.set(0, 1.3, 6);
camera.lookAt(0, 1.5, 0);

// ===== RESIZE =====
function resize() {
  renderer.setSize(window.innerWidth, window.innerHeight);
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
}
resize();
window.addEventListener('resize', resize);

// ===== LIGHTING =====
const ambient = new THREE.AmbientLight(0xffffff, 0.6);
scene.add(ambient);
const sunLight = new THREE.DirectionalLight(0xfff8e7, 1.2);
sunLight.position.set(5, 10, 5);
sunLight.castShadow = true;
scene.add(sunLight);
const fillLight = new THREE.PointLight(0xfff0cc, 0.4, 30);
fillLight.position.set(-5, 5, 5);
scene.add(fillLight);

// ===== HELPERS =====
function box(w,h,d,color,rx=0) {
  const g = new THREE.BoxGeometry(w,h,d);
  const m = new THREE.MeshLambertMaterial({color});
  const mesh = new THREE.Mesh(g,m);
  mesh.castShadow = true;
  mesh.receiveShadow = true;
  return mesh;
}
function cyl(rt,rb,h,seg,color) {
  const g = new THREE.CylinderGeometry(rt,rb,h,seg);
  const m = new THREE.MeshLambertMaterial({color});
  const mesh = new THREE.Mesh(g,m);
  mesh.castShadow = true;
  return mesh;
}
function sphere(r,color) {
  const g = new THREE.SphereGeometry(r,16,16);
  const m = new THREE.MeshLambertMaterial({color});
  const mesh = new THREE.Mesh(g,m);
  mesh.castShadow = true;
  return mesh;
}

// ===== BUILD CLASSROOM =====
function buildRoom() {
  // Floor
  const floor = box(20,0.2,20,0x8B6914);
  floor.position.set(0,-0.1,5);
  floor.receiveShadow = true;
  scene.add(floor);

  // Floor tiles
  const tileGeo = new THREE.PlaneGeometry(20,20,10,10);
  const tileMat = new THREE.MeshLambertMaterial({color:0xd4c08a});
  const tile = new THREE.Mesh(tileGeo,tileMat);
  tile.rotation.x = -Math.PI/2;
  tile.position.set(0,0.01,5);
  tile.receiveShadow = true;
  scene.add(tile);

  // Back wall
  const backWall = box(20,8,0.3,0xf5f0e0);
  backWall.position.set(0,4,-5);
  scene.add(backWall);

  // Side walls
  const lWall = box(0.3,8,20,0xede8d8);
  lWall.position.set(-10,4,5);
  scene.add(lWall);
  const rWall = box(0.3,8,20,0xede8d8);
  rWall.position.set(10,4,5);
  scene.add(rWall);

  // Ceiling
  const ceil = box(20,0.2,20,0xfafaf5);
  ceil.position.set(0,8,5);
  scene.add(ceil);

  // Front wall (behind camera)
  const frontWall = box(20,8,0.3,0xede8d8);
  frontWall.position.set(0,4,15);
  scene.add(frontWall);

  // ===== BLACKBOARD =====
  const bbFrame = box(7.5,3.5,0.15,0x8B6914);
  bbFrame.position.set(0,3.5,-4.85);
  scene.add(bbFrame);
  const bb = box(7,3,0.16,0x1a3d1a);
  bb.position.set(0,3.5,-4.84);
  scene.add(bb);

  // Chalk lines on board
  createChalkText();

  // Teacher desk
  const tDesk = box(2.5,0.1,1.2,0x8B6914);
  tDesk.position.set(0,0.95,-3.5);
  scene.add(tDesk);
  const tDeskLeg1 = box(0.08,0.95,0.08,0x6b5335);
  tDeskLeg1.position.set(-1.15,0.475,-3);
  scene.add(tDeskLeg1);
  const tDeskLeg2 = box(0.08,0.95,0.08,0x6b5335);
  tDeskLeg2.position.set(1.15,0.475,-3);
  scene.add(tDeskLeg2);

  // ===== WINDOWS (side walls) =====
  for (let z of [-2, 4]) {
    const winFrame = box(0.15,2.5,2,0xc4a882);
    winFrame.position.set(-9.85,4,z);
    scene.add(winFrame);
    const win = box(0.1,2,1.6,0x87ceeb);
    win.position.set(-9.84,4,z);
    const winMat = new THREE.MeshLambertMaterial({color:0x87ceeb, transparent:true, opacity:0.5});
    const winMesh = new THREE.Mesh(new THREE.BoxGeometry(0.1,2,1.6), winMat);
    winMesh.position.set(-9.84,4,z);
    scene.add(winMesh);
  }

  // ===== STUDENT DESKS =====
  const rows    = [0, 1.8, 3.6, 5.4, 7.2];
  const cols    = [-4, -1.5, 1.5, 4];
  const skinTones = [0xFDBCB4, 0xF1A173, 0xD4875A, 0xC36B3A, 0xA0522D, 0xFDDCB4];
  const shirts    = [0xe74c3c, 0x3498db, 0x2ecc71, 0x9b59b6, 0xf39c12, 0x1abc9c, 0xe67e22, 0x16a085];

  rows.forEach((rz,ri) => {
    cols.forEach((cx,ci) => {
      // Skip our seats (row 4, col 1 & 2 = index based on myId later)
      const isOurSpot = ri===4 && (ci===1 || ci===2);

      buildDesk(cx, rz);

      if (!isOurSpot) {
        // Background student
        const skin = skinTones[(ri*4+ci) % skinTones.length];
        const shirt = shirts[(ri*3+ci) % shirts.length];
        buildBgStudent(cx, rz, skin, shirt);
      }
    });
  });
}

function buildDesk(x,z) {
  const top = box(1.1,0.06,0.75,0x9b7b4a);
  top.position.set(x,0.85,z);
  scene.add(top);
  for (let lx of [-0.45,0.45]) {
    for (let lz of [-0.28,0.28]) {
      const leg = box(0.05,0.85,0.05,0x7a6035);
      leg.position.set(x+lx, 0.425, z+lz);
      scene.add(leg);
    }
  }
  // Chair
  const seat = box(0.7,0.05,0.65,0x5a4020);
  seat.position.set(x, 0.52, z+0.7);
  scene.add(seat);
  const back = box(0.7,0.55,0.05,0x5a4020);
  back.position.set(x, 0.8, z+1.02);
  scene.add(back);
}

function buildBgStudent(x, z, skin, shirt) {
  const g = new THREE.Group();
  // Body
  const body = box(0.38,0.52,0.24,shirt);
  body.position.set(0,0,0);
  g.add(body);
  // Head
  const head = sphere(0.18,skin);
  head.position.set(0,0.38,0);
  g.add(head);
  // Hair
  const hair = sphere(0.185,0x3d2b1a);
  hair.position.set(0,0.46,0);
  hair.scale.y = 0.5;
  g.add(hair);

  g.position.set(x, 1.1, z+0.65);
  g.rotation.y = Math.PI;
  scene.add(g);
}

// ===== TEACHER =====
let teacherGroup, teacherHead;
let teacherAngle = 0;
let teacherDir = 1;

function buildTeacher() {
  teacherGroup = new THREE.Group();

  // Body
  const body = box(0.45,0.7,0.28,0x1a237e);
  body.position.y = 0;
  teacherGroup.add(body);

  // Tie
  const tie = box(0.07,0.5,0.02,0xc0392b);
  tie.position.set(0,0.05,0.15);
  teacherGroup.add(tie);

  // Head
  teacherHead = sphere(0.22,0xFDBCB4);
  teacherHead.position.y = 0.5;
  teacherGroup.add(teacherHead);

  // Hair
  const hair = sphere(0.225,0x2c1810);
  hair.position.set(0,0.58,0);
  hair.scale.y = 0.55;
  teacherGroup.add(hair);

  // Glasses
  const glassL = cyl(0.06,0.06,0.01,12,0x333333);
  glassL.rotation.x = Math.PI/2;
  glassL.position.set(-0.09,0.52,0.21);
  teacherGroup.add(glassL);
  const glassR = glassL.clone();
  glassR.position.x = 0.09;
  teacherGroup.add(glassR);
  const bridge = box(0.12,0.01,0.01,0x333333);
  bridge.position.set(0,0.52,0.21);
  teacherGroup.add(bridge);

  // Arms
  const armL = box(0.1,0.5,0.1,0x1a237e);
  armL.position.set(-0.28,-0.05,0);
  armL.rotation.z = 0.3;
  teacherGroup.add(armL);
  const armR = armL.clone();
  armR.position.x = 0.28;
  armR.rotation.z = -0.3;
  teacherGroup.add(armR);

  // Chalk stick
  const chalk = cyl(0.015,0.015,0.25,6,0xffffff);
  chalk.rotation.z = Math.PI/2;
  chalk.position.set(0.45,0,0);
  teacherGroup.add(chalk);

  // Legs
  const legL = box(0.14,0.55,0.18,0x263238);
  legL.position.set(-0.12,-0.62,0);
  teacherGroup.add(legL);
  const legR = legL.clone();
  legR.position.x = 0.12;
  teacherGroup.add(legR);

  teacherGroup.position.set(-2.5, 1.3, -3.8);
  scene.add(teacherGroup);
}

// ===== NAME TAG SPRITES =====
const nameTags = {}; // playerId -> sprite

function makeNameTag(name, role, color) {
  const canvas = document.createElement('canvas');
  canvas.width = 320; canvas.height = 80;
  const ctx = canvas.getContext('2d');

  // bg
  ctx.fillStyle = 'rgba(0,0,0,0.75)';
  roundRect(ctx, 0, 0, 320, 80, 20);
  ctx.fill();

  // border
  ctx.strokeStyle = color || '#a78bfa';
  ctx.lineWidth = 3;
  roundRect(ctx, 1.5, 1.5, 317, 77, 19);
  ctx.stroke();

  // name
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 34px Segoe UI';
  ctx.textAlign = 'center';
  ctx.fillText(name, 160, 40);

  // role tag
  if (role) {
    ctx.fillStyle = color || '#a78bfa';
    ctx.font = 'bold 22px Segoe UI';
    ctx.fillText(role, 160, 66);
  }

  const tex = new THREE.CanvasTexture(canvas);
  const mat = new THREE.SpriteMaterial({map:tex, transparent:true, depthTest:false});
  const sprite = new THREE.Sprite(mat);
  sprite.scale.set(1.8, 0.45, 1);
  return sprite;
}

function roundRect(ctx,x,y,w,h,r) {
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);
  ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);
  ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}

// ===== PLAYER 3D CHARACTERS =====
const playerChars = {}; // playerId -> group
const seatPositions = [
  {x:-1.5, z:7.2},
  {x: 1.5, z:7.2}
];
const seatColors = [0x7c3aed, 0x0891b2];

function buildPlayerChar(pid, name, seatIdx) {
  const g = new THREE.Group();
  const col = seatColors[seatIdx % seatColors.length];

  const body = box(0.38,0.52,0.24,col);
  body.position.y = 0;
  g.add(body);

  const head = sphere(0.19,0xFDBCB4);
  head.position.y = 0.4;
  g.add(head);

  const hair = sphere(0.195,0x2c1810);
  hair.position.set(0,0.48,0);
  hair.scale.y = 0.55;
  g.add(hair);

  // Eyes
  const eyeL = sphere(0.03,0x222222);
  eyeL.position.set(-0.07,0.42,0.18);
  g.add(eyeL);
  const eyeR = eyeL.clone();
  eyeR.position.x = 0.07;
  g.add(eyeR);

  const pos = seatPositions[seatIdx];
  g.position.set(pos.x, 1.1, pos.z+0.5);
  g.rotation.y = Math.PI;
  scene.add(g);

  // Name tag
  const tag = makeNameTag(name, pid===myId?'üéØ Sen':'üë• Arkada≈üƒ±n', pid===myId?'#a78bfa':'#f472b6');
  tag.position.set(pos.x, 2.3, pos.z+0.5);
  scene.add(tag);

  playerChars[pid] = {group:g, tag, seatIdx, talking:false, pokingAnim:0};
  nameTags[pid] = tag;
}

// ===== CHALK TEXT =====
function createChalkText() {
  // Decorative lines on blackboard
  const mat = new THREE.LineBasicMaterial({color:0xf0ede0, opacity:0.7, transparent:true});
  for (let i=0;i<4;i++) {
    const pts = [new THREE.Vector3(-3, 3.1-(i*0.45), -4.75), new THREE.Vector3(3, 3.1-(i*0.45), -4.75)];
    const geo = new THREE.BufferGeometry().setFromPoints(pts);
    scene.add(new THREE.Line(geo,mat));
  }
}

// ===== TALK BUBBLE (in 3D) =====
function makeTalkBubble() {
  const cv = document.createElement('canvas');
  cv.width = 200; cv.height = 80;
  const ctx = cv.getContext('2d');
  ctx.fillStyle = '#fff';
  ctx.beginPath();
  ctx.roundRect(5,5,190,60,14);
  ctx.fill();
  ctx.fillStyle = '#333';
  ctx.font = 'bold 26px Segoe UI';
  ctx.textAlign = 'center';
  ctx.fillText('psst... üó£Ô∏è', 100, 40);
  const tex = new THREE.CanvasTexture(cv);
  const mat = new THREE.SpriteMaterial({map:tex, transparent:true, depthTest:false});
  const sp = new THREE.Sprite(mat);
  sp.scale.set(1.2,0.48,1);
  sp.visible = false;
  return sp;
}

// ===== CAMERA CONTROL =====
let camYaw = 0;    // horizontal rotation (look left/right)
let camPitch = 0;  // vertical tilt
let gyroAvail = false;
let touchStartX = 0, touchStartY = 0;
let dragCamYaw = 0, dragCamPitch = 0;
let isDragging = false;

// Our seat position
const SEAT_POS = {x:0, y:1.35, z:7.8};

function setupCamera() {
  camera.position.set(SEAT_POS.x, SEAT_POS.y, SEAT_POS.z);
}

// Gyroscope
function setupGyro() {
  if (window.DeviceOrientationEvent) {
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
      // iOS 13+
      const btn = document.createElement('button');
      btn.textContent = 'üì± Sens√∂r√º Etkinle≈ütir';
      btn.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:500;padding:14px 24px;background:#7c3aed;color:#fff;border:none;border-radius:14px;font-size:1em;font-weight:700;';
      document.body.appendChild(btn);
      btn.onclick = async () => {
        const perm = await DeviceOrientationEvent.requestPermission();
        if (perm === 'granted') { enableGyro(); }
        btn.remove();
      };
    } else {
      enableGyro();
    }
  }
}

function enableGyro() {
  gyroAvail = true;
  window.addEventListener('deviceorientation', onGyro);
  showGyroTip();
}

let gyroAlpha0 = null, gyroBeta0 = null;

function onGyro(e) {
  if (!gameOn) return;
  if (gyroAlpha0 === null) { gyroAlpha0 = e.alpha; gyroBeta0 = e.beta; }

  let da = e.alpha - gyroAlpha0;
  if (da > 180) da -= 360;
  if (da < -180) da += 360;

  let db = e.beta - gyroBeta0;

  camYaw   = THREE.MathUtils.clamp(-da * 0.018, -Math.PI*0.85, Math.PI*0.85);
  camPitch = THREE.MathUtils.clamp( db * 0.018, -0.6, 0.9);
}

// Touch drag fallback
canvas.addEventListener('touchstart', e => {
  if (!gameOn) return;
  touchStartX = e.touches[0].clientX;
  touchStartY = e.touches[0].clientY;
  dragCamYaw   = camYaw;
  dragCamPitch = camPitch;
  isDragging = true;
}, {passive:true});

canvas.addEventListener('touchmove', e => {
  if (!gameOn || !isDragging) return;
  const dx = (e.touches[0].clientX - touchStartX) / window.innerWidth;
  const dy = (e.touches[0].clientY - touchStartY) / window.innerHeight;
  camYaw   = THREE.MathUtils.clamp(dragCamYaw   - dx*3.5, -Math.PI*0.9, Math.PI*0.9);
  camPitch = THREE.MathUtils.clamp(dragCamPitch + dy*2.5, -0.6, 0.9);
}, {passive:true});

canvas.addEventListener('touchend', () => { isDragging = false; });

// Mouse drag
canvas.addEventListener('mousedown', e => {
  if (!gameOn) return;
  touchStartX = e.clientX; touchStartY = e.clientY;
  dragCamYaw = camYaw; dragCamPitch = camPitch;
  isDragging = true;
});
canvas.addEventListener('mousemove', e => {
  if (!isDragging || !gameOn) return;
  const dx = (e.clientX - touchStartX) / window.innerWidth;
  const dy = (e.clientY - touchStartY) / window.innerHeight;
  camYaw   = THREE.MathUtils.clamp(dragCamYaw   - dx*3.5, -Math.PI*0.9, Math.PI*0.9);
  camPitch = THREE.MathUtils.clamp(dragCamPitch + dy*2.5, -0.6, 0.9);
});
canvas.addEventListener('mouseup', () => isDragging = false);

function showGyroTip() {
  const tip = document.getElementById('gyroTip');
  tip.style.opacity = '1';
  setTimeout(() => tip.style.opacity='0', 3500);
}

// ===== COMPASS =====
function updateCompass() {
  const deg = Math.round(camYaw * 180 / Math.PI);
  const dirs = ['K','KD','D','GD','G','GB','B','KB'];
  const idx = Math.round(((-deg + 360) % 360) / 45) % 8;
  document.getElementById('cmpDir').textContent = dirs[idx];
  document.getElementById('cmpDeg').textContent = Math.abs(deg)+'¬∞';
}

// ===== ROOM LOGIC =====
function genCode() { return Math.random().toString(36).substr(2,4).toUpperCase(); }

async function createRoom() {
  const n = document.getElementById('inName').value.trim();
  if (!n) { alert('ƒ∞sminizi girin!'); return; }
  myName = n; roomCode = genCode(); isHost = true;
  const data = { players:{[myId]:{name:n,id:myId}}, state:'waiting', events:[], ts:Date.now() };
  await rSet(`cls:${roomCode}`, data);
  showWaiting();
  startPoll();
}

async function joinRoom() {
  const n = document.getElementById('inName').value.trim();
  const c = document.getElementById('inCode').value.trim().toUpperCase();
  if (!n) { alert('ƒ∞sminizi girin!'); return; }
  if (!c) { alert('Oda kodunu girin!'); return; }
  myName = n; roomCode = c; isHost = false;
  const data = await rGet(`cls:${roomCode}`);
  if (!data) { alert('Oda bulunamadƒ±!'); return; }
  if (data.state==='playing') { alert('Oyun ba≈üladƒ±!'); return; }
  if (Object.keys(data.players).length>=2) { alert('Oda dolu!'); return; }
  data.players[myId] = {name:n, id:myId};
  await rSet(`cls:${roomCode}`, data);
  showWaiting();
  startPoll();
}

function showWaiting() {
  document.getElementById('lobby').style.display = 'none';
  document.getElementById('waiting').style.display = 'flex';
  document.getElementById('dispCode').textContent = roomCode;
}

function startPoll() {
  pollInt = setInterval(pollRoom, 1200);
  pollRoom();
}
function stopPoll() { clearInterval(pollInt); pollInt=null; }

async function pollRoom() {
  const data = await rGet(`cls:${roomCode}`);
  if (!data) return;
  players = data.players;
  const pArr = Object.values(players);

  // Render waiting UI
  if (document.getElementById('waiting').style.display!=='none') {
    const wpl = document.getElementById('wPlayers');
    wpl.innerHTML = '';
    for (let i=0;i<2;i++) {
      const p = pArr[i];
      wpl.innerHTML += `<div class="p-slot"><div class="p-dot ${p?'on':'off'}"></div><div class="p-name">${p?p.name:'Bekleniyor...'}</div></div>`;
    }
    document.getElementById('wMsg').textContent = pArr.length>=2 ? '‚úÖ Oyun ba≈ülƒ±yor!' : 'Arkada≈üƒ±n katƒ±lsƒ±n...';

    if (pArr.length>=2) {
      if (isHost && data.state==='waiting') {
        data.state = 'playing';
        await rSet(`cls:${roomCode}`, data);
      }
      if (data.state==='playing') {
        setTimeout(() => startGame(pArr), 500);
        stopPoll();
      }
    }
  } else if (gameOn) {
    processEvents(data.events || []);
  }
}

// ===== START GAME =====
function startGame(pArr) {
  document.getElementById('waiting').style.display = 'none';
  document.getElementById('hud').style.display = 'block';
  document.getElementById('compass').style.display = 'flex';
  gameOn = true; score = 0; danger = 0;
  seenEvts = new Set();

  setupCamera();

  // Build characters
  pArr.forEach((p, i) => {
    buildPlayerChar(p.id, p.name, i);
    const tb = makeTalkBubble();
    const pos = seatPositions[i];
    tb.position.set(pos.x, 2.65, pos.z+0.4);
    scene.add(tb);
    playerChars[p.id].talkBubble = tb;
  });

  setupGyro();
  startGameLoop();
  startPoll();
  animate();
}

// ===== GAME LOOP =====
let scoreTick = 0;
let teacherLookCD = 0;
let teacherLookDur = 0;

function startGameLoop() {
  gameInt = setInterval(() => {
    if (!gameOn) return;
    scoreTick++;
    if (scoreTick%10===0) {
      score++;
      document.getElementById('scoreNum').textContent = score;
    }

    // Danger decay
    if (!talking) danger = Math.max(0, danger-0.25);
    if (talking)  danger = Math.min(100, danger+1.8);
    updateDanger();

    // Teacher wander
    teacherAngle += 0.012 * teacherDir;
    if (teacherAngle > 0.9 || teacherAngle < -0.9) teacherDir *= -1;
    if (teacherGroup) {
      teacherGroup.position.x = Math.sin(teacherAngle)*2.5;
      teacherGroup.rotation.y = -teacherAngle*0.5;
    }

    // Random teacher look
    teacherLookCD--;
    if (teacherLookCD <= 0 && !teacherWatching) {
      teacherLookCD = 60 + Math.floor(Math.random()*80);
      triggerLook();
    }
    if (teacherWatching) {
      teacherLookDur--;
      if (teacherLookDur<=0) { teacherWatching=false; }
      if (talking && teacherWatching) { caught(); }
    }

    // Animate player chars
    Object.values(playerChars).forEach(pc => {
      if (pc.pokingAnim > 0) {
        pc.pokingAnim--;
        pc.group.position.x += Math.sin(pc.pokingAnim*0.8)*0.02;
      }
    });
  }, 100);
}

function triggerLook() {
  teacherWatching = true;
  teacherLookDur = 25 + Math.floor(Math.random()*20);
  showAlert('alertTeacher');
  if (teacherHead) {
    teacherHead.scale.set(1.15,1.15,1.15);
    setTimeout(()=>teacherHead.scale.set(1,1,1), 400);
  }
}

function updateDanger() {
  const bar = document.getElementById('dangerBar');
  bar.style.width = danger+'%';
  bar.style.background = danger>70?'#ef4444':danger>40?'#f59e0b':'#22c55e';
}

// ===== ACTIONS =====
function startTalk(e) {
  if (e) e.preventDefault();
  const btn = document.getElementById('btnTalk');
  if (btn.classList.contains('disabled')) return;
  talking = true;
  pushEvt({type:'talk',pid:myId,on:true});
  const pc = playerChars[myId];
  if (pc && pc.talkBubble) pc.talkBubble.visible = true;
}
function stopTalk(e) {
  if (e) e.preventDefault();
  if (!talking) return;
  talking = false;
  pushEvt({type:'talk',pid:myId,on:false});
  const pc = playerChars[myId];
  if (pc && pc.talkBubble) pc.talkBubble.visible = false;
}

async function doPoke() {
  const btn = document.getElementById('btnPoke');
  if (btn.classList.contains('disabled')) return;
  const pc = playerChars[myId];
  if (pc) { pc.pokingAnim = 8; }
  await pushEvt({type:'poke',from:myId,fromName:myName});
  btn.classList.add('disabled');
  let cd=4;
  btn.querySelector('.cd-txt').textContent = cd+'s';
  const t = setInterval(()=>{
    cd--;
    btn.querySelector('.cd-txt').textContent = cd+'s';
    if (cd<=0){ clearInterval(t); btn.classList.remove('disabled'); }
  },1000);
}

// ===== EVENTS =====
async function pushEvt(ev) {
  const data = await rGet(`cls:${roomCode}`);
  if (!data) return;
  ev.id = Math.random().toString(36).substr(2,8);
  ev.ts = Date.now();
  if (!data.events) data.events=[];
  data.events.push(ev);
  if (data.events.length>30) data.events=data.events.slice(-30);
  await rSet(`cls:${roomCode}`, data);
}

function processEvents(evts) {
  evts.forEach(ev => {
    if (seenEvts.has(ev.id) || ev.pid===myId || ev.from===myId) {
      seenEvts.add(ev.id); return;
    }
    seenEvts.add(ev.id);

    if (ev.type==='talk') {
      const pc = playerChars[ev.pid];
      if (pc && pc.talkBubble) pc.talkBubble.visible = ev.on;
    }
    if (ev.type==='poke') {
      const myPC = playerChars[myId];
      if (myPC) { myPC.pokingAnim = 10; }
      showAlert('alertPoke', `üëâ ${ev.fromName||'Arkada≈üƒ±n'} seni d√ºrt√ºyor!`);
    }
    if (ev.type==='caught') { caught(true); }
  });
}

// ===== CAUGHT =====
async function caught(remote=false) {
  if (!gameOn) return;
  gameOn = false; talking = false;
  clearInterval(gameInt);
  if (!remote) await pushEvt({type:'caught'});
  document.getElementById('finalScore').textContent = score;
  setTimeout(()=>{
    document.getElementById('caught').style.display='flex';
  }, 500);
}

function restartGame() {
  document.getElementById('caught').style.display='none';
  score=0; danger=0; talking=false; teacherWatching=false;
  seenEvts=new Set();
  Object.values(playerChars).forEach(pc=>{
    if(pc.talkBubble) pc.talkBubble.visible=false;
  });
  gameOn=true;
  startGameLoop();
}
function goLobby() {
  location.reload();
}

// ===== ALERTS =====
function showAlert(id, txt) {
  const el = document.getElementById(id);
  if (txt) el.textContent = txt;
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), 2800);
}

// ===== RENDER =====
function animate() {
  requestAnimationFrame(animate);

  if (gameOn) {
    // Apply camera rotation from gyro/drag
    // Sit at back of class, look toward blackboard
    camera.position.set(SEAT_POS.x, SEAT_POS.y, SEAT_POS.z);

    // Camera target: default toward blackboard (z=-4), allow rotation
    const baseDir = new THREE.Vector3(0, 0, -1); // looking toward -Z
    const euler = new THREE.Euler(camPitch, camYaw, 0, 'YXZ');
    baseDir.applyEuler(euler);
    camera.lookAt(
      camera.position.x + baseDir.x,
      camera.position.y + baseDir.y,
      camera.position.z + baseDir.z
    );

    updateCompass();

    // Animate teacher chalk arm
    if (teacherGroup) {
      teacherGroup.children.forEach(c=>{
        if (c.userData.isArm) c.rotation.z = Math.sin(Date.now()*0.003)*0.3;
      });
    }

    // Pulse name tags
    const t = Date.now()*0.001;
    Object.entries(playerChars).forEach(([pid, pc]) => {
      if (nameTags[pid]) {
        nameTags[pid].material.opacity = 0.8 + Math.sin(t*1.5+pid.charCodeAt(0))*0.2;
      }
    });
  }

  renderer.render(scene, camera);
}

// ===== INIT =====
buildRoom();
buildTeacher();
animate();

document.getElementById('inCode').addEventListener('input', e=>{
  e.target.value = e.target.value.toUpperCase();
});

// Prevent default touch behaviors
document.addEventListener('touchmove', e=>e.preventDefault(), {passive:false});
</script>
</body>
</html>
